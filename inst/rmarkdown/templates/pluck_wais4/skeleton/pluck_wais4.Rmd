---
title: "Pluck Tables from WAIS-IV"
params:
  test:
    label: "Test: WAIS-IV"
    value: wais4
    input: select
    multiple: no
    choices:
      - wais4
      - wisc5
  file:
    label: "No file selected"
    value: file
    input: file
  pages:
    label: "Pages"
    value: NULL
    input: text
  table1:
    label: Index Scores
    value: Verbal Comprehension (VCI)
    input: select
    multiple: yes
    choices:
      - Verbal Comprehension (VCI)
      - Perceptual Reasoning (PRI)
      - Working Memory (WMI)
      - Processing Speed (PSI)
      - Full Scale IQ (FSIQ)
      - General Ability (GAI)
  table2:
    label: Verbal Comprehension (VCI)
    value: Similarities
    input: select
    multiple: yes
    choices:
      - Similarities
      - Vocabulary
      - Information
      - Comprehension
  table3:
    label: Perceptual Reasoning (PRI)
    value: Block Design
    input: select
    multiple: yes
    choices:
      - Block Design
      - Matrix Reasoning
      - Visual Puzzles
      - Figure Weights
  table4:
    label: Working Memory (WMI)
    value: Digit Span
    input: select
    multiple: yes
    choices:
      - Digit Span
      - Arithmetic
      - Letter-Number Sequencing
  table5:
    label: Processing Speed (PSI)
    value: Symbol Search
    input: select
    multiple: yes
    choices:
      - Symbol Search
      - Coding
      - Cancellation
  table6:
    label: Perceptual Reasoning Process Score Summary
    value: Block Design No Time Bonus
    input: select
    multiple: yes
    choices:
      - Block Design No Time Bonus
  table7:
    label: Working Memory Process Score Summary
    value: Digit Span Forward
    input: select
    multiple: yes
    choices:
      - Digit Span Forward
      - Digit Span Backward
      - Digit Span Sequencing
      - Longest Digit Span Backward
      - Longest Digit Span Forward
      - Longest Digit Span Sequence
      - Longest Letter-Number Sequence
  colnames1:
    label: "Table 1 Column Names"
    value: "scale"
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - abbrev
      - score
      - percentile
      - ci_95
      - category
  colnames2:
    label: "Table 2-6 Column Names"
    value: scale
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - ref_group_ss
      - sem
  colnames3:
    label: "Table 7 Column Names"
    value: scale
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - base_rate
      - sem
  keep1:
    label: "Variable to Keep, Set 1"
    value: scale
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - ci_95
  keep2:
    label: "Variable to Keep, Set 2"
    value: scale
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
---

# WAIS-IV

```{r patient, include=FALSE}
patient <- "Alex"
```

## Load libraries

```{r setup, include=FALSE}
Sys.setenv(JAVA_HOME = "/Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home")
options(java.parameters = "-Xmx16000m")
library(knitr)
library(xfun)
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = TRUE
)
library(bwu)
library(tabulizer)
library(tabulizerjars)
library(rJava)
library(shiny)
library(miniUI)
library(here)
library(pdftools)
library(tidyverse)
library(fs)
library(data.table)
library(magrittr)
library(kableExtra)
library(formattable)
library(DT)
library(ggiraph)
library(hablar)
library(tibble)
library(png)
```

## Upload/attach PDF

```{r choose, include=FALSE}
file <- params$file
readr::write_lines(file, here::here(patient, "pre_csv", "wais4_pdf"))
file <- readr::read_lines(here::here(patient, "pre_csv", "wais4_pdf"))
```

## Pages

```{r pages, include=FALSE}
pages <- list(params$pages)
```

## Locate areas

```{r predetermined, include=FALSE}
# if known
area <- list(
  c(133, 50, 212, 560),
  c(347, 50, 382, 560),
  c(434, 50, 468, 560),
  c(521, 50, 553, 560),
  c(605, 50, 639, 560),
  c(429, 50, 446, 560),
  c(508, 50, 618, 560) 
)
# if unknown
# area <- gpluck_locate_areas(
#   file = params$file,
#   pages = params$pages
# )
readr::write_rds(area, here::here(patient, "pre_csv", "area_wais4.rds"))
area <- readr::read_rds(here::here(patient, "pre_csv", "area_wais4.rds"))
```

## Extract tables

```{r extract, include=FALSE, cache=TRUE}
plucked_table = gpluck_extract_table(
  file = file,
  pages = pages,
  area = area,
  guess = NULL,
  method = "stream",
  output = "matrix"
)
```

# WAIS-IV Index Scores

## Pluck and format tables

### Convert to tibble and format

```{r pluck1}
colnames1 <- params$colnames1
table1 <- as_tibble(plucked_table[[1]])
colnames(table1) <- params$colnames1
table1 <- dplyr::na_if(table1, "")
table1 <- dplyr::na_if(table1, "NA")
table1 <- dplyr::na_if(table1, "-")
table1 <- dplyr::na_if(table1, "--")
table1 <- dplyr::na_if(table1, "---")
to_double <- c("raw_score", "score", "percentile")
table1 <- table1 |> hablar::convert(dbl(all_of(to_double)))
```

### Scale names

```{r rownam1}
rownames(table1) <- params$table1
table1 <- 
  table1 %>% 
  dplyr::rename(scale2 = scale) %>% 
  tibble::rownames_to_column(., var = "scale")
```

### Select variables to keep

```{r select1}
table1 <- table1 |> dplyr::select(all_of(params$keep1))
```

### Create/Insert/Mutate new columns in table

```{r mutate1}
table1 <- gpluck_make_columns(
  table1,
  range = "",
  test = "wais4",
  test_name = "WAIS-IV",
  domain = "",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "",
  test_type = "npsych_test",
  score_type = "standard_score",
  description = ""
)
```

## Domains

```{r domain1}
table1 <-
  table1 |>
  mutate(
    domain = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Intelligence/General Ability",
      scale == "Perceptual Reasoning (PRI)" ~ "Intelligence/General Ability",
      scale == "Working Memory (WMI)" ~ "Attention/Executive",
      scale == "Processing Speed (PSI)" ~ "Attention/Executive",
      scale == "Full Scale IQ (FSIQ)" ~ "Intelligence/General Ability",
      scale == "General Ability (GAI)" ~ "Intelligence/General Ability",
      TRUE ~ as.character(domain)
    )
  )
```

## Subdomain

```{r subdomain1}
table1 <-
  table1 |>
  mutate(
    subdomain = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Crystallized Intelligence",
      scale == "Perceptual Reasoning (PRI)" ~ "Fluid Intelligence",
      scale == "Working Memory (WMI)" ~ "Working Memory",
      scale == "Processing Speed (PSI)" ~ "Processing Speed",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence",
      scale == "General Ability (GAI)" ~ "General Intelligence",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomain

```{r narrow1}
table1 <-
  table1 |>
  mutate(
    narrow = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Crystallized Intelligence",
      scale == "Perceptual Reasoning (PRI)" ~ "Fluid Intelligence",
      scale == "Working Memory (WMI)" ~ "Working Memory",
      scale == "Processing Speed (PSI)" ~ "Processing Speed",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence",
      scale == "General Ability (GAI)" ~ "General Intelligence",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS model

```{r pass1}
table1 <-
  table1 |>
  mutate(
    pass = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "",
      scale == "Perceptual Reasoning (PRI)" ~ "",
      scale == "Working Memory (WMI)" ~ "",
      scale == "Processing Speed (PSI)" ~ "",
      scale == "Full Scale IQ (FSIQ)" ~ "",
      scale == "General Ability (GAI)" ~ "",
      TRUE ~ as.character(pass)
    )
  )
```

## Verbal vs Nonverbal

```{r verbal1}
table1 <-
  table1 |>
  mutate(
    verbal = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Verbal",
      scale == "Perceptual Reasoning (PRI)" ~ "Nonverbal",
      scale == "Working Memory (WMI)" ~ "Verbal",
      scale == "Processing Speed (PSI)" ~ "Nonverbal",
      scale == "Full Scale IQ (FSIQ)" ~ "",
      scale == "General Ability (GAI)" ~ "",
      TRUE ~ as.character(verbal)
    )
  )
```

## Timed vs Untimed

```{r timed1}
table1 <-
  table1 |>
  mutate(
    timed = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Untimed",
      scale == "Perceptual Reasoning (PRI)" ~ "Timed",
      scale == "Working Memory (WMI)" ~ "Untimed",
      scale == "Processing Speed (PSI)" ~ "Timed",
      scale == "Full Scale IQ (FSIQ)" ~ "",
      scale == "General Ability (GAI)" ~ "",
      TRUE ~ as.character(timed)
    )
  )
```

### Description

```{r desc1}
table1 <-
  table1 |>
  mutate(
    description = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "acquired knowledge, verbal concept formation, verbal reasoning, verbal comprehension and expression, and practical knowledge and judgment",
      scale == "Perceptual Reasoning (PRI)" ~ "fluid reasoning, spatial processing, and visual-motor integration",
      scale == "Working Memory (WMI)" ~ "ability to consciously register, maintain, and manipulate information in working memory",
      scale == "Processing Speed (PSI)" ~ "ability to quickly use reasoning to identify and apply solutions to problems",
      scale == "Full Scale IQ (FSIQ)" ~ "general level of intellectual functioning",
      scale == "General Ability (GAI)" ~ "a subset of intellectual functioning with reduced influences of working memory and processing speed",
      TRUE ~ as.character(description)
    )
  )
```

### Test score ranges

```{r range1}
table1 <- gpluck_make_score_ranges(table = table1, test_type = "npsych_test")
```

## Finalize and save

### Relocate variables

```{r relocate1}
table1 <- table1 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# VCI

```{r pluck2}
table2 <- as_tibble(plucked_table[[2]])
colnames(table2) <- params$colnames2
table2 <- dplyr::na_if(table2, "")
table2 <- dplyr::na_if(table2, "NA")
table2 <- dplyr::na_if(table2, "-")
table2 <- dplyr::na_if(table2, "--")
table2 <- dplyr::na_if(table2, "---")
to_double <- c("raw_score", "score", "percentile")
table2 <- table2 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames2}
rownames(table2) <- params$table2
table2 <- 
  table2 %>% 
  dplyr::rename(scale2 = scale) %>% 
  tibble::rownames_to_column(., var = "scale")
```

## Select variables to keep

```{r keep2}
table2 <- table2 |> dplyr::select(all_of(params$keep2))
```

### Create/Insert/Mutate new columns in table

```{r maketbl2}
table2 <- gpluck_make_columns(
  table2,
  range = "",
  ci_95 = "",
  test = "wais4",
  test_name = "WAIS-IV",
  domain = "Verbal/Language",
  subdomain = "",
  narrow = "",
  pass = "Successive",
  verbal = "Verbal",
  timed = "Untimed",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

### Test score ranges

```{r}
table2 <- gpluck_make_score_ranges(table = table2, test_type = "npsych_test")
```

### Subdomains

```{r subdomain2}
table2 <-
  table2 |>
  mutate(
    subdomain = case_when(
      scale == "Similarities" ~ "Acquired Knowledge",
      scale == "Vocabulary" ~ "Acquired Knowledge",
      scale == "Information" ~ "Acquired Knowledge",
      scale == "Comprehension" ~ "Acquired Knowledge",
      TRUE ~ as.character(subdomain)
    )
  )
```

### Narrow subdomains

```{r narrow2}
table2 <-
  table2 |>
  mutate(
    narrow = case_when(
      scale == "Similarities" ~ "Verbal Reasoning",
      scale == "Vocabulary" ~ "Lexical Knowledge",
      scale == "Information" ~ "General Verbal Information",
      scale == "Comprehension" ~ "General Verbal Information",
      TRUE ~ as.character(narrow)
    )
  )
```

### Scale descriptions

```{r desc-vci}
table2 <-
  table2 |>
  mutate(
    description = case_when(
      scale == "Similarities" ~ "verbal concept formation and abstract word reasoning",
      scale == "Vocabulary" ~ "expressive vocabulary, verbal concept formation, and word knowledge",
      scale == "Information" ~ "acquired knowledge/ability to acquire, retain, and retrieve general factual knowledge",
      scale == "Comprehension" ~ "practical knowledge and judgment of general principles and social situations",
      TRUE ~ as.character(description)
    )
  )
```

## Finalize and save

### relocate variables

```{r relocate-t2}
table2 <- table2 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# PRI

```{r tb3}
table3 <- tibble::as_tibble(plucked_table[[3]])
colnames(table3) <- params$colnames2
table3 <- dplyr::na_if(table3, "")
table3 <- dplyr::na_if(table3, "NA")
table3 <- dplyr::na_if(table3, "-")
table3 <- dplyr::na_if(table3, "--")
table3 <- dplyr::na_if(table3, "---")
to_double <- c("raw_score", "score", "percentile")
table3 <- table3 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames3}
rownames(table3) <- params$table3
table3 <- 
  table3 %>% 
  dplyr::rename(scale2 = scale) %>% 
  tibble::rownames_to_column(., var = "scale")
```

## select variables to keep

```{r keep3}
table3 <- table3 |> dplyr::select(all_of(params$keep2))
```

## Insert/mutate columns

```{r mutate3}
table3 <- gpluck_make_columns(
  table3,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = "WAIS-IV",
  domain = "Visual Perception/Construction",
  subdomain = "",
  narrow = "",
  timed = "",
  verbal = "Nonverbal",
  pass = "Simultaneous",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

## Test score ranges

```{r ranges3}
table3 <- gpluck_make_score_ranges(table = table3, test_type = "npsych_test")
```

## Subdomains

```{r subdomain3}
table3 <-
  table3 |>
  mutate(
    subdomain = case_when(
      scale == "Block Design" ~ "Visual Processing",
      scale == "Matrix Reasoning" ~ "Fluid Reasoning",
      scale == "Visual Puzzles" ~ "Visual Processing",
      scale == "Figure Weights" ~ "Fluid Reasoning",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomain

```{r narrow3}
table3 <-
  table3 |>
  mutate(
    narrow = case_when(
      scale == "Block Design" ~ "Visual Cconstruction",
      scale == "Matrix Reasoning" ~ "Inductive Reasoning",
      scale == "Visual Puzzles" ~ "Visualization",
      scale == "Figure Weights" ~ "General Sequential Reasoning",
      TRUE ~ as.character(narrow)
    )
  )
```

## Timed vs Untimed

```{r timed3}
table3 <-
  table3 |>
  mutate(
    timed = case_when(
      scale == "Block Design" ~ "Timed",
      scale == "Matrix Reasoning" ~ "Untimed",
      scale == "Visual Puzzles" ~ "Timed",
      scale == "Figure Weights" ~ "Timed",
      TRUE ~ as.character(timed)
    )
  )
```

## Description

```{r desc3}
table3 <-
  table3 |>
  mutate(
    description = case_when(
      scale == "Block Design" ~ "visuoconstruction and integration of blocks; visual-spatial processing and visual-motor integration",
      scale == "Matrix Reasoning" ~ "nonverbal/fluid inductive reasoning and problem-solving; fluid intelligence, classification and spatial ability, simultaneous processing, attention to visual detail, and working memory",
      scale == "Visual Puzzles" ~ "visuoperceptual integration and reasoning; analyze and synthesize abstract visual stimuli",
      scale == "Figure Weights" ~ "fluid/quantitative reasoning; quantitative and inductive reasoning, mental flexibility, and set shifting",
      TRUE ~ as.character(description)
    )
  )
```

### relocate variables

```{r relocate3}
table3 <- table3 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# WMI

## Table 4

```{r pluck4}
table4 <- as_tibble(plucked_table[[4]])
colnames(table4) <- params$colnames2
table4 <- dplyr::na_if(table4, "")
table4 <- dplyr::na_if(table4, "NA")
table4 <- dplyr::na_if(table4, "-")
table4 <- dplyr::na_if(table4, "--")
table4 <- dplyr::na_if(table4, "---")
to_double <- c("raw_score", "score", "percentile")
table4 <- table4 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames4}
rownames(table4) <- params$table4
table4 <- 
  table4 %>% 
  dplyr::rename(scale2 = scale) %>% 
  tibble::rownames_to_column(., var = "scale")
```

## Select variables to keep

```{r keep4}
table4 <- table4 |> dplyr::select(all_of(params$keep2))
```

## Mutate columns

```{r mutate4}
table4 <- gpluck_make_columns(
  table4,
  range = "",
  ci_95 = "",
  test = "wais4",
  test_name = "WAIS-IV",
  domain = "Attention/Executive",
  subdomain = "Working Memory",
  narrow = "",
  pass = "Attention",
  verbal = "Verbal",
  timed = "Untimed",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

### Test score ranges

```{r ranges4}
table4 <- gpluck_make_score_ranges(table = table4, test_type = "npsych_test")
```

### Subdomains

```{r subdomain4}
table4 <-
  table4 |>
  mutate(
    subdomain = case_when(
      scale == "Digit Span" ~ "Working Memory",
      scale == "Arithmetic" ~ "Working Memory",
      scale == "Letter-Number Sequencing" ~ "Working Memory",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r narrow4}
table4 <-
  table4 |>
  mutate(
    narrow = case_when(
      scale == "Digit Span" ~ "Working Memory Capacity",
      scale == "Arithmetic" ~ "Working Memory Capacity",
      scale == "Letter-Number Sequencing" ~ "Working Memory Capacity",
      TRUE ~ as.character(narrow)
    )
  )
```

## Timed vs Untimed

```{r timed4}
table4 <-
  table4 |>
  mutate(
    timed = case_when(
      scale == "Digit Span" ~ "Untimed",
      scale == "Arithmetic" ~ "Timed",
      scale == "Letter-Number Sequencing" ~ "Untimed",
      TRUE ~ as.character(timed)
    )
  )
```

### PASS model

```{r pass4}
table4 <-
  table4 |>
  mutate(
    pass = case_when(
      scale == "Digit Span" ~ "Attention",
      scale == "Arithmetic" ~ "Attention",
      scale == "Letter-Number Sequencing" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

### Scale descriptions

```{r desc4}
table4 <-
  table4 |>
  mutate(
    description = case_when(
      scale == "Digit Span" ~ "working memory, in addition to auditory attention, sequential processing, and mental manipulation",
      scale == "Arithmetic" ~ "mental manipulation, concentration, and working memory; short- and long-term memory; fluid, quantitative, and logical reasoning; sequential processing; and quantiative knowledge",
      scale == "Letter-Number Sequencing" ~ "sequencing and working memory, as well as auditory sequential processing, immediate auditory memory, attention, numerical ability, and visual-spatial imaging",
      TRUE ~ as.character(description)
    )
  )
```

### Relocate variables

```{r reloc5}
table4 <- table4 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# PSI

## Table 5

```{r pluck5}
table5 <- as_tibble(plucked_table[[5]])
colnames(table5) <- params$colnames2
table5 <- dplyr::na_if(table5, "")
table5 <- dplyr::na_if(table5, "NA")
table5 <- dplyr::na_if(table5, "-")
table5 <- dplyr::na_if(table5, "--")
table5 <- dplyr::na_if(table5, "---")
to_double <- c("raw_score", "score", "percentile")
table5 <- table5 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames5}
rownames(table5) <- params$table5
table5 <- 
  table5 %>% 
  dplyr::rename(scale2 = scale) %>% 
  tibble::rownames_to_column(., var = "scale")
```

## Select variables to keep

```{r keep5}
table5 <- table5 |> dplyr::select(all_of(params$keep2))
```

## Mutate columns

```{r mutate5}
table5 <- gpluck_make_columns(
  table5,
  range = "",
  ci_95 = "",
  test = "wais4",
  test_name = "WAIS-IV",
  domain = "Attention/Executive",
  subdomain = "Processing Speed",
  narrow = "",
  pass = "Planning",
  verbal = "Nonverbal",
  timed = "Timed",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

### Test score ranges

```{r ranges5}
table5 <- gpluck_make_score_ranges(table = table5, test_type = "npsych_test")
```

### Subdomains

```{r subdomain5}
table5 <-
  table5 |>
  mutate(
    subdomain = case_when(
      scale == "Coding" ~ "Processing Speed",
      scale == "Symbol Search" ~ "Processing Speed",
      scale == "Cancellation" ~ "Processing Speed",
      TRUE ~ as.character(subdomain)
    )
  )
```

### Narrow subdomains

```{r narrow5}
table5 <-
  table5 |>
  mutate(
    narrow = case_when(
      scale == "Coding" ~ "Cognitive Efficiency",
      scale == "Symbol Search" ~ "Perceptual Speed",
      scale == "Cancellation" ~ "Selective Attention",
      TRUE ~ as.character(narrow)
    )
  )
```

### PASS model

```{r pass5}
table5 <-
  table5 |>
  mutate(
    pass = case_when(
      scale == "Cancellation" ~ "Attention",
      scale == "Coding" ~ "Planning",
      scale == "Symbol Search" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

### Scale descriptions

```{r desc5}
table5 <-
  table5 |>
  mutate(
    description = case_when(
      scale == "Coding" ~ "visual-motor processing speed, as well as graphomotor speed, short-term memory, learning ability, visual acuity, sequential processing, and attention to visual stimuli",
      scale == "Symbol Search" ~ "visual-motor processing speed, as well as short-term visual memory, perceputal organization, learning ability, perceptual and psychomotor speed, visual-motor coordination, visual discrimination, and attention to visual stimuli",
      scale == "Cancellation" ~ "selective visual attention, rate of test-taking, perceptual speed, visual discrimination, and visual-perceptual processing",
      TRUE ~ as.character(description)
    )
  )
```

### Relocate variables

```{r reloc5}
table5 <- table5 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# PROCESS ANALYSIS TABLE 6

## Table 6

```{r pluck6}
table6 <- as_tibble(plucked_table[[6]])
colnames(table6) <- params$colnames2
table6 <- dplyr::na_if(table6, "")
table6 <- dplyr::na_if(table6, "NA")
table6 <- dplyr::na_if(table6, "-")
table6 <- dplyr::na_if(table6, "--")
table6 <- dplyr::na_if(table6, "---")
to_double <- c("raw_score", "score", "percentile")
table6 <- table6 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames6}
rownames(table6) <- params$table6
table6 <- 
  table6 %>% 
  dplyr::rename(scale2 = scale) %>% 
  tibble::rownames_to_column(., var = "scale")
```

## Select variables to keep

```{r keep6}
table6 <- table6 |> dplyr::select(all_of(params$keep2))
```

## Mutate columns

```{r mutate6}
table6 <- gpluck_make_columns(
  table6,
  range = "",
  ci_95 = "",
  test = "wais4",
  test_name = "WAIS-IV",
  domain = "Visual Perception/Construction",
  subdomain = "Visual Processing",
  narrow = "Visual Construction",
  timed = "Untimed",
  verbal = "Nonverbal",
  pass = "Simultaneous",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

### Test score ranges

```{r ranges6}
table6 <- gpluck_make_score_ranges(table = table6, test_type = "npsych_test")
```

### Scale descriptions

```{r desc6}
table6 <-
  table6 |>
  mutate(
    description = case_when(
      scale == "Block Design No Time Bonus" ~ "visuoconstruction and integration of blocks; visual-spatial processing and visual-motor integration (untimed)",
      TRUE ~ as.character(description)
    )
  )
```

### Relocate variables

```{r reloc6}
table6 <- table6 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# PROCESS ANALYSIS TABLE 7

## Table 7

```{r pluck7}
table7 <- tibble::as_tibble(plucked_table[[7]])
colnames(table7) <- params$colnames3
table7 <- dplyr::na_if(table7, "")
table7 <- dplyr::na_if(table7, "NA")
table7 <- dplyr::na_if(table7, "-")
table7 <- dplyr::na_if(table7, "--")
table7 <- dplyr::na_if(table7, "---")
to_double <- c("raw_score", "score", "percentile")
table7 <- table7 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames7}
rownames(table7) <- params$table7
table7 <- 
  table7 %>% 
  dplyr::rename(scale2 = scale) %>% 
  tibble::rownames_to_column(., var = "scale")
```

## variables to keep

```{r keep7}
table7 <- table7 |> dplyr::select(all_of(params$keep2))
```

## Mutate columns

```{r mutate7}
table7 <- gpluck_make_columns(
  table7,
  range = "",
  ci_95 = "",
  test = "wais4",
  test_name = "WAIS-IV",
  domain = "Attention/Executive",
  subdomain = "Working Memory",
  narrow = "",
  pass = "",
  verbal = "Verbal",
  timed = "Untimed",
  test_type = "npsych_test",
  score_type = "",
  description = ""
)
```

### Test score ranges

```{r ranges7}
table7 <- gpluck_make_score_ranges(table = table7, test_type = "npsych_test")
```

## Narrow subdomains

```{r narrow7}
table7 <-
  table7 |>
  mutate(
    narrow = case_when(
      scale == "Digit Span Backward" ~ "Working Memory Capacity",
      scale == "Digit Span Forward" ~ "Memory Span",
      scale == "Digit Span Sequencing" ~ "Working Memory Capacity",
      scale == "Longest Digit Span Backward" ~ "Working Memory Capacity",
      scale == "Longest Digit Span Forward" ~ "Memory Span",
      scale == "Longest Digit Span Sequence" ~ "Working Memory Capacity",
      scale == "Longest Letter-Number Sequence" ~ "Working Memory Capacity",
      TRUE ~ as.character(narrow)
    )
  )
```

### PASS model

```{r pass7}
table7 <-
  table7 |>
  mutate(
    pass = case_when(
      scale == "Digit Span Forward" ~ "Attention",
      scale == "Digit Span Backward" ~ "Attention",
      scale == "Digit Span Sequencing" ~ "Attention",
      scale == "Longest Digit Span Forward" ~ "Attention",
      scale == "Longest Digit Span Backward" ~ "Attention",
      scale == "Longest Digit Span Sequence" ~ "Attention",
      scale == "Longest Letter-Number Sequence" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

### Score type

```{r score7}
table7 <-
  table7 |>
  mutate(
    score_type = case_when(
      scale == "Digit Span Backward" ~ "scaled_score",
      scale == "Digit Span Forward" ~ "scaled_score",
      scale == "Digit Span Sequencing" ~ "scaled_score",
      scale == "Longest Digit Span Backward" ~ "raw_score",
      scale == "Longest Digit Span Forward" ~ "raw_score",
      scale == "Longest Digit Span Sequence" ~ "raw_score",
      scale == "Longest Letter-Number Sequence" ~ "raw_score",
      TRUE ~ as.character(score_type)
    )
  )
```

### Scale descriptions

```{r desc7}
table7 <-
  table7 |>
  mutate(
    description = case_when(
      scale == "Digit Span Backward" ~ "recall of digits backward",
      scale == "Digit Span Forward" ~ "recall of digits forward",
      scale == "Digit Span Sequencing" ~ "recall of digits sequencing",
      scale == "Longest Digit Span Backward" ~ "recall of digits backward (span)",
      scale == "Longest Digit Span Forward" ~ "recall of digits forward (span)",
      scale == "Longest Digit Span Sequence" ~ "recall of digits sequence (span)",
      scale == "Longest Letter-Number Sequence" ~ "longest letter-number sequence (span)",
      TRUE ~ as.character(description)
    )
  )
```

### Relocate variables

```{r reloc7}
table7 <- table7 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# Finalize and save

## Merge tables

```{r merge}
wais4 <- 
  dplyr::bind_rows(table1, table2, table3, table6, table4, table7, table5)
```

## Slice to reorder subtests/scales
```{r slice}
# eight subtest table
wais4 <- wais4 %>% dplyr::slice(5,1,6:7,2,9,8,10,3,12,11,13:15,4,21,20)
```

## Write out final csv

```{r write}
readr::write_csv(wais4, here::here(patient, "csv", "wais4.csv"), col_names = TRUE, na = "")
```

## Cleanup

```{r cleanup}
rm(area, plucked_table, table1, table2, table3, table4, table5, table6, table7)
```

---
title: "Pluck Tables from WMS-IV"
---

# WMS-IV

## Patient

```{r patient}
patient <- "MAX"
```

## Pages

Need to check each PDF to see what page(s) tables are located on.

```{r}
pages <- c(10, 11)
```

## Test

```{r test}
test <- "wms4"
```

## Load libraries

```{r setup, include=F}
Sys.setenv(JAVA_HOME = "/Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home")
options(java.parameters = "-Xmx16000m")
library(knitr)
library(xfun)
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = TRUE
)
library(tabulizer)
library(tabulizerjars)
library(rJava)
library(shiny)
library(miniUI)
library(here)
library(pdftools)
library(tidyverse)
library(fs)
library(data.table)
library(magrittr)
library(kableExtra)
library(formattable)
library(DT)
library(ggiraph)
library(hablar)
library(tibble)
```

```{r source-functions}
source(file = here::here("R/gpluck_locate_areas.R"), local = knitr::knit_global())
source(file = here::here("R/gpluck_extract_table.R"), local = knitr::knit_global())
source(file = here::here("R/gpluck_make_columns.R"), local = knitr::knit_global())
source(file = here::here("R/gpluck_make_score_ranges.R"), local = knitr::knit_global())
```

# TabulizeR

## File choose

```{r choose}
wms4_pdf <- file.choose()
```

```{r save}
readr::write_lines(wms4_pdf, here::here(patient, "pre_csv", "wms4_pdf"))
```

```{r read}
wms4_pdf <- readr::read_lines(here::here(patient, "pre_csv", "wms4_pdf"))
```

## Locate areas

```{r}
area <- list(c(157.973,50.49,176.333,559.98))
```

```{r}
area <- gpluck_locate_areas(
  file = wms4_pdf,
  pages = pages
)
```

```{r save-areas}
readr::write_rds(area, here::here(patient, "pre_csv", "area_wms4.rds"))
```

```{r read-areas}
area <- readr::read_rds(here::here(patient, "pre_csv", "area_wms4.rds"))
```

## Extract tables

```{r extract}
table <- gpluck_extract_table(
  file = wms4_pdf,
  pages = pages,
  area = area,
  guess = NULL,
  method = "stream",
  output = "matrix"
)
```

# Tidy Tables

## Column names

```{r colnames}
column_names <- c(
  "scale",
  "domain",
  "raw_score",
  "score",
  "percentile"
)
column_names2 <- c(
  "scale",
  "raw_score",
  "score",
  "percentile",
  "base_rate"
)
```

## Select table

```{r tb1}
table1 <- as_tibble(table[[1]])
colnames(table1) <- column_names
table1 <- dplyr::na_if(table1, "")
table1 <- dplyr::na_if(table1, "NA")
table1 <- dplyr::na_if(table1, "-")
table1 <- dplyr::na_if(table1, "--")
table1 <- dplyr::na_if(table1, "---")
to_double <- c("raw_score", "score", "percentile")
table1 <- table1 |> hablar::convert(dbl(all_of(to_double)))
```

## Row names

As necessary.

```{r tb1-rownames}
# table1[1, 1] <- c("Logical Memory I")
# table1[2, 1] <- c("Logical Memory II")
# table1[3, 1] <- c("Verbal Paired Associates I")
# table1[4, 1] <- c("Verbal Paired Associates I")
# table1[5, 1] <- c("Designs I")
# table1[6, 1] <- c("Designs II")
table1[1, 1] <- c("Visual Reproduction I")
table1[2, 1] <- c("Visual Reproduction II")
table1[3, 1] <- c("Spatial Addition")
#table1[1, 1] <- c("Symbol Span")
```

## Select variables to keep

```{r}
keep <- c("scale", "raw_score", "score", "percentile")
table1 <- table1 |> dplyr::select(all_of(keep))
```

## Create/Insert/Mutate new columns in table

```{r}
table1 <- gpluck_make_columns(
  table1,
  range = "",
  ci_95 = "",
  test = "wms4",
  test_name = "WMS-IV",
  domain = "Memory",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

## Test score ranges

```{r}
table1 <- gpluck_make_score_ranges(table = table1, test_type = "npsych_test")
```

## Domain

As necessary.

```{r domain1}
table1 <-
  table1 %>% 
  mutate(
    domain = case_when(
      scale == "Symbol Span" ~ "Attention/Executive",
      scale == "Spatial Addition" ~ "Attention/Executive",
      TRUE ~ as.character(domain)
    )
  )
```

## Subdomains

As necessary.

```{r subdomain1}
table1 <-
  table1 |>
  mutate(
    subdomain = case_when(
      scale == "Logical Memory I" ~ "Long-Term Storage and Retrieval",
      scale == "Logical Memory II" ~ "Long-Term Storage and Retrieval",
      scale == "Visual Reproduction I" ~ "Long-Term Storage and Retrieval",
      scale == "Visual Reproduction II" ~ "Long-Term Storage and Retrieval",
      scale == "Symbol Span" ~ "Working Memory",
      scale == "Spatial Addition" ~ "Working Memory",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r narrow1}
table1 <-
  table1 |>
  mutate(
    narrow = case_when(
      scale == "Logical Memory I" ~ "Story Memory",
      scale == "Logical Memory II" ~ "Story Memory",
      scale == "Visual Reproduction I" ~ "Visual Memory",
      scale == "Visual Reproduction II" ~ "Visual Memory",
      scale == "Symbol Span" ~ "Visual Working Memory",
      scale == "Spatial Addition" ~ "Visual Working Memory",
      TRUE ~ as.character(narrow)
    )
  )
```

## Timed vs Untimed

```{r timed1}
table1 <-
  table1 |>
  mutate(
    timed = case_when(
      scale == "Logical Memory I" ~ "Untimed",
      scale == "Logical Memory II" ~ "Untimed",
      scale == "Visual Reproduction I" ~ "Untimed",
      scale == "Visual Reproduction II" ~ "Untimed",
      scale == "Symbol Span" ~ "Untimed",
      scale == "Spatial Addition" ~ "Untimed",
      TRUE ~ as.character(timed)
    )
  )
```

## Verbal vs Nonverbal

```{r verbal1}
table1 <-
  table1 |>
  mutate(
    verbal = case_when(
      scale == "Logical Memory I" ~ "Verbal",
      scale == "Logical Memory II" ~ "Verbal",
      scale == "Visual Reproduction I" ~ "Nonverbal",
      scale == "Visual Reproduction II" ~ "Nonverbal",
      scale == "Symbol Span" ~ "Nonverbal",
      scale == "Spatial Addition" ~ "Nonverbal",
      TRUE ~ as.character(verbal)
    )
  )
```

## PASS model

```{r pass1}
table1 <-
  table1 |>
  mutate(
    pass = case_when(
      scale == "Logical Memory I" ~ "Successive",
      scale == "Logical Memory II" ~ "Successive",
      scale == "Visual Reproduction I" ~ "Simultaneous",
      scale == "Visual Reproduction II" ~ "Simultaneous",
      scale == "Symbol Span" ~ "Attention",
      scale == "Spatial Addition" ~ "",
      TRUE ~ as.character(pass)
    )
  )
```

## Description

```{r desc1}
table1 <-
  table1 |>
  mutate(
    description = case_when(
      scale == "Logical Memory I" ~ "memory for structured information presened orally (encoding and immediate retrieval)",
      scale == "Logical Memory II" ~ "memory for structured information presened orally (long-term retrieval)",
      scale == "Visual Reproduction I" ~ "a measure of memory for visual details and spatial location, immediate visual memory for abstract designs",
      scale == "Visual Reproduction II" ~ "long-term visual memory for abstract designs",
      scale == "Symbol Span" ~ "nonverbal/visual working memory utilizing proactive interference",
      scale == "Spatial Addition" ~ "doing spatial counting/addition",
      TRUE ~ as.character(description)
    )
  )
```

# Finalize and save

## Relocate variables

```{r}
wms4 <-
  table1 |> relocate(c(raw_score, score, percentile, range, ci_95), .before = test) %>%
  filter(!is.na(raw_score)) %>%
  filter(!is.na(score)) %>%
  filter(!is.na(percentile))
```

## Write out final csv table

```{r}
readr::write_csv(wms4, here::here(patient, "csv", "wms4.csv"), col_names = TRUE, na = "")
```

## Cleanup

```{r eval=T}
rm(table)
rm(area)
```

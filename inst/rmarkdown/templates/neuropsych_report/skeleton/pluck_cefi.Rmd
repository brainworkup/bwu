---
title: "Pluck Tables from CEFI"
params:
  patient: Biggie
  test:
    label: "Test"
    value: [cefi_sr]
    input: select
    multiple: no
    choices:
      - cefi_sr
      - cefi_or
  test_name:
    label: "Test Name:"
    value: [CEFI Self-Report]
    input: select
    multiple: no
    choices:
      - CEFI Self-Report
      - CEFI Observer-Report
  file:
    label: "No file selected"
    value: file
    input: file
  pages: [3, 3]
output:
  rmdformats::robobook:
    highlight: kate
---

# CEFI SR/OR

## Load libraries

```{r setup, include = FALSE}
Sys.setenv(
  JAVA_HOME =
    "/Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home"
)
options(java.parameters = "-Xmx16000m")
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = TRUE
)
library(bwu)
library(hablar)
library(here)
library(knitr)
library(magrittr)
library(miniUI)
library(readr)
library(rJava)
library(rmarkdown)
library(shiny)
library(tabulizer)
library(tabulizerjars)
library(tibble)
library(tidyr)
library(tidytable)
library(vroom)
```

## Patient

```{r patient}
patient <- params$patient
```

## Test

```{r test}
test <- params$test
```

## Test Name

```{r testname}
test_name <- params$test_name
```

## Upload/attach PDF

```{r file}
# file <- file.choose()
file <- params$file
```

## Pages

```{r pages}
pages <- params$pages
```

```{r write-file}
writeLines(file, here::here(patient, "pre_csv", paste0(test, ".pdf")))
```

```{r read-file}
# test <- readLines(here::here(patient, "pre_csv", paste0(test, ".pdf")))
```

## Locate areas

```{r areas-known}
area <- list(
  c(460, 34, 483, 578),
  c(533, 34, 671, 578)
)
```

```{r areas-unknown, eval=F}
# area <- gpluck_locate_areas(
#   file = cefi_sr_pdf,
#   pages = pages
# )
```

```{r save-area}
saveRDS(area, here::here(patient, "pre_csv", paste0(test, "_area.rds")))
```

```{r read-area}
# area <- readRDS(here::here(patient, "pre_csv", paste0(test, "_area.rds")))
```

## Extract table

```{r extract}
plucked_table <- bwu::gpluck_extract_table(
  file = file,
  pages = pages,
  area = area,
  guess = NULL,
  method = "stream",
  output = "matrix"
)
```

# Tidy Tables

## Column names per test/subtest/measure

```{r colname}
colnames1 <- c(
  "score",
  "ci_95",
  "percentile",
  "category"
)
colnames2 <- c(
  "scale",
  "score",
  "ci_95",
  "percentile",
  "category",
  "diff_from_avg",
  "stat",
  "strength"
)
```

## CEFI Full Scale

```{r pluck1}
table1 <- tibble::as_tibble(plucked_table[[1]], .name_repair = "unique")
colnames(table1) <- colnames1
to_double <- c("score", "percentile")
table1 <-
  table1 |>
  hablar::convert(dbl(all_of(to_double))) |>
  tidytable::mutate(scale = "") |>
  tidytable::relocate(scale, .before = score)
if (params$test == "cefi_sr") {
  table1[1, 1] <- c("Full Scale")
} else {
  table1[1, 1] <- c("Full Scale")
}
```

## CEFI Subscales

```{r pluck2}
table2 <- as_tibble(plucked_table[[2]], .name_repair = "unique")
colnames(table2) <- colnames2
to_double <- c("score", "percentile")
table2 <- table2 |> hablar::convert(dbl(all_of(to_double)))
# rename
if (params$test == "cefi_sr") {
  table2[1, 1] <- c("Attention")
  table2[2, 1] <- c("Emotion Regulation")
  table2[3, 1] <- c("Flexibility")
  table2[4, 1] <- c("Inhibitory Control")
  table2[5, 1] <- c("Initiation")
  table2[6, 1] <- c("Organization")
  table2[7, 1] <- c("Planning")
  table2[8, 1] <- c("Self-Monitoring")
  table2[9, 1] <- c("Working Memory")
} else if (params$test == "cefi_or") {
  table2[1, 1] <- c("Attention")
  table2[2, 1] <- c("Emotion Regulation")
  table2[3, 1] <- c("Flexibility")
  table2[4, 1] <- c("Inhibitory Control")
  table2[5, 1] <- c("Initiation")
  table2[6, 1] <- c("Organization")
  table2[7, 1] <- c("Planning")
  table2[8, 1] <- c("Self-Monitoring")
  table2[9, 1] <- c("Working Memory")
}
```

## Select variables to keep

```{r select}
keep <- c("scale", "score", "percentile", "ci_95")
table1 <- table1 |> tidytable::select(all_of(keep))
table2 <- table2 |> tidytable::select(all_of(keep))
table <- tidytable::bind_rows(table1, table2)
```

## Mutate columns

```{r mutate}
table <- bwu::gpluck_make_columns(
  table,
  raw_score = "",
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Executive Functioning",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "",
  test_type = "rating_scale",
  score_type = "standard_score",
  description = "",
  result = ""
)
```

## Test score ranges

```{r ranges}
# might need to be explicit about test_type
table <- bwu::gpluck_make_score_ranges(
  table = table,
  test_type = "rating_scale"
)
```

## Subdomains

```{r subdomain}
table <-
  table |>
  tidytable::mutate(
    subdomain = tidytable::case_when(
      scale == "Full Scale" ~ "Full Scale",
      scale == "Attention" ~ "Attention",
      scale == "Emotion Regulation" ~ "Emotion Regulation",
      scale == "Flexibility" ~ "Flexibility",
      scale == "Inhibitory Control" ~ "Inhibitory Control",
      scale == "Initiation" ~ "Initiation",
      scale == "Organization" ~ "Organization",
      scale == "Planning" ~ "Planning",
      scale == "Self-Monitoring" ~ "Self-Monitoring",
      scale == "Working Memory" ~ "Working Memory",
      scale == "Full Scale" ~ "Full Scale",
      scale == "Attention" ~ "Attention",
      scale == "Emotion Regulation" ~ "Emotion Regulation",
      scale == "Flexibility" ~ "Flexibility",
      scale == "Inhibitory Control" ~ "Inhibitory Control",
      scale == "Initiation" ~ "Initiation",
      scale == "Organization" ~ "Organization",
      scale == "Planning" ~ "Planning",
      scale == "Self-Monitoring" ~ "Self-Monitoring",
      scale == "Working Memory" ~ "Working Memory",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r narrow}
if (params$test == "cefi_sr") {
  table <-
    table |>
    tidytable::mutate(
      narrow = tidytable::case_when(
        scale == "Full Scale" ~ "CEFI-SR Full Scale",
        scale == "Attention" ~ "CEFI-SR Attention",
        scale == "Emotion Regulation" ~ "CEFI-SR Emotion Regulation",
        scale == "Flexibility" ~ "CEFI-SR Flexibility",
        scale == "Inhibitory Control" ~ "CEFI-SR Inhibitory Control",
        scale == "Initiation" ~ "CEFI-SR Initiation",
        scale == "Organization" ~ "CEFI-SR Organization",
        scale == "Planning" ~ "CEFI-SR Planning",
        scale == "Self-Monitoring" ~ "CEFI-SR Self-Monitoring",
        scale == "Working Memory" ~ "CEFI-SR Working Memory",
        TRUE ~ as.character(narrow)
      )
    )
} else {
  table <-
    table |>
    tidytable::mutate(
      narrow = tidytable::case_when(
        scale == "Full Scale" ~ "CEFI-OR Full Scale",
        scale == "Attention" ~ "CEFI-OR Attention",
        scale == "Emotion Regulation" ~ "CEFI-OR Emotion Regulation",
        scale == "Flexibility" ~ "CEFI-OR Flexibility",
        scale == "Inhibitory Control" ~ "CEFI-OR Inhibitory Control",
        scale == "Initiation" ~ "CEFI-OR Initiation",
        scale == "Organization" ~ "CEFI-OR Organization",
        scale == "Planning" ~ "CEFI-OR Planning",
        scale == "Self-Monitoring" ~ "CEFI-OR Self-Monitoring",
        scale == "Working Memory" ~ "CEFI-OR Working Memory",
        TRUE ~ as.character(narrow)
      )
    )
}
```

## Scale descriptions

```{r description}
if (params$test == "cefi_sr") {
  table <-
    table |>
    tidytable::mutate(
      description = tidytable::case_when(
        scale ==
          "Full Scale" ~
          "overall level of executive functioning",
        scale ==
          "Attention" ~
          "i.e., avoid distractions, concentrate on tasks, and sustain attention",
        scale ==
          "Emotion Regulation" ~
          "i.e., control and manage emotions, including staying calm when handling small problems and reacting with the right level of emotion",
        scale ==
          "Flexibility" ~
          "i.e., adjust behavior to meet circumstances, including coming up with different ways to solve problems, changing behavior when needed, and being able to come up with new ways to reach a goal",
        scale ==
          "Inhibitory Control" ~
          "i.e., control behavior or impulses, including thinking about consequences before acting, maintaining self-control, and thinking before speaking",
        scale ==
          "Initiation" ~
          "i.e., begin tasks or projects on own, including starting tasks easily, being motivated, and taking the initiative when needed",
        scale ==
          "Organization" ~
          "i.e., manage personal effects, work, or multiple tasks, including organizing tasks and thoughts well, managing time effectively, and working neatly",
        scale ==
          "Planning" ~
          "i.e., develop and implement strategies to accomplish tasks, including planning ahead and making good decisions",
        scale ==
          "Self-Monitoring" ~
          "i.e., evaluate own behavior in order to determine when a different approach is necessary, including noticing and fixing mistakes, knowing when help is required, and understanding when a task is completed",
        scale ==
          "Working Memory" ~
          "i.e., keep information in mind that is important for knowing what to do and how to do it, including remembering important things, instructions, and steps",
        TRUE ~ as.character(description)
      )
    )
} else {
  table <-
    table |>
    tidytable::mutate(
      description = tidytable::case_when(
        scale ==
          "Full Scale" ~
          "overall level of executive functioning",
        scale ==
          "Attention" ~
          "i.e., avoid distractions, concentrate on tasks, and sustain attention",
        scale ==
          "Emotion Regulation" ~
          "i.e., control and manage emotions, including staying calm when handling small problems and reacting with the right level of emotion",
        scale ==
          "Flexibility" ~
          "i.e., adjust behavior to meet circumstances, including coming up with different ways to solve problems, changing behavior when needed, and being able to come up with new ways to reach a goal",
        scale ==
          "Inhibitory Control" ~
          "i.e., control behavior or impulses, including thinking about consequences before acting, maintaining self-control, and thinking before speaking",
        scale ==
          "Initiation" ~
          "i.e., begin tasks or projects on own, including starting tasks easily, being motivated, and taking the initiative when needed",
        scale ==
          "Organization" ~
          "i.e., manage personal effects, work, or multiple tasks, including organizing tasks and thoughts well, managing time effectively, and working neatly",
        scale ==
          "Planning" ~
          "i.e., develop and implement strategies to accomplish tasks, including planning ahead and making good decisions",
        scale ==
          "Self-Monitoring" ~
          "i.e., evaluate own behavior in order to determine when a different approach is necessary, including noticing and fixing mistakes, knowing when help is required, and understanding when a task is completed",
        scale ==
          "Working Memory" ~
          "i.e., keep information in mind that is important for knowing what to do and how to do it, including remembering important things, instructions, and steps",
        TRUE ~ as.character(description)
      )
    )
}
```

## Glue results

```{r result}
if (params$test == "cefi_sr") {
  table <-
    table |>
    tidytable::mutate(
      result = tidytable::case_when(
        scale == "Full Scale" ~ glue::glue(
          "- {patient}'s {description} was {range}.\n"
        ),
        scale == "Attention" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Emotion Regulation" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Flexibility" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Inhibitory Control" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Initiation" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Organization" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Planning" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Self-Monitoring" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Working Memory" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        TRUE ~ as.character(result)
      )
    )
} else {
  table <-
    table |>
    tidytable::mutate(
      result = tidytable::case_when(
        scale == "Full Scale" ~ glue::glue(
          "- {patient}'s {description} was {range}.\n"
        ),
        scale == "Attention" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Emotion Regulation" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Flexibility" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Inhibitory Control" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Initiation" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Organization" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Planning" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Self-Monitoring" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        scale == "Working Memory" ~ glue::glue(
          "- {scale} ({description}) was {range}\n"
        ),
        TRUE ~ as.character(result)
      )
    )
}
```

# Finalize and save

## Relocate variables

```{r relocate}
table <-
  table |>
  tidytable::relocate(
    c(raw_score, score, percentile, range, ci_95), .before = test)
```

## Write csv

```{r writeout}
readr::write_csv(
  table, here::here(patient, "csv", paste0(test, ".csv")), col_names = TRUE, na = "")
```

## Pluck Text

```{r text}
file <- fs::as_fs_path(params$file)

if (params$test == "cefi_sr") {
  ## extract text
  get_text <- function(file) {
    txt <- pdftools::pdf_text(file) |>
      stringr::str_split("\n") |>
      unlist()
  }
  cefi_sr_txt <- pdftools::pdf_text(file) |>
    stringr::str_split("\n") |>
    unlist()
  cefi_sr_txt

  # Replace long spaces with a col break symbol

  cefi_sr_squished <-
    stringr::str_replace_all(cefi_sr_txt, "\\s{2,}", "- ") |>
    stringr::str_remove_all(",")
  cefi_sr_squished

  readr::write_lines(cefi_sr_squished, here::here(patient, "cefi_sr_text.md"), sep = "\n")
  readr::write_lines(cefi_sr_squished, here::here(patient, "cefi_sr_text.qmd"), sep = "\n")
} else {
  ## extract text
  get_text <- function(file) {
    txt <- pdftools::pdf_text(file) |>
      stringr::str_split("\n") |>
      unlist()
  }
  cefi_or_txt <- pdftools::pdf_text(file) |>
    stringr::str_split("\n") |>
    unlist()
  cefi_or_txt

  # Replace long spaces with a col break symbol
  cefi_or_squished <-
    stringr::str_replace_all(cefi_or_txt, "\\s{2,}", "- ") |>
    stringr::str_remove_all(",")
  cefi_or_squished

  readr::write_lines(cefi_or_squished, here::here(patient, "cefi_or_text.md"), sep = "\n")
  readr::write_lines(cefi_or_squished, here::here(patient, "cefi_or_text.qmd"), sep = "\n")

}
```

---
title: "Pluck Tables from WRAT-5"
params:
  patient: Biggie
  test:
    label: "Test"
    value: wrat5
    input: select
    multiple: no
    choices:
      - wrat5
      - wrat4
  test_name:
    label: "Test Name"
    value: [WRAT-5]
    input: select
    multiple: no
    choices:
      - "WRAT-5"
      - "WRAT-4"
  file:
    label: "No file selected"
    value: file
    input: file
  pages: [8]
  table1:
    label: "SCORE SUMMARY"
    value: [Word Reading]
    input: select
    multiple: yes
    choices:
      - Math Computation
      - Spelling
      - Word Reading
      - Sentence Comprehension
      - Reading Composite
  colnames1:
    label: "Table 1 Column Names"
    value: [scale, raw_score, score, ci_95, percentile, category, grade_equiv, gsv]
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - ci_95
      - percentile
      - category
  keep1:
    label: "Variables to Keep, Set 1"
    value: [scale, raw_score, score, percentile, ci_95]
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - ci_95
# Domains to evaluate or not
  eval_iq:
    label: "General Cognitive Ability"
    value: TRUE
  eval_vci:
    label: "Verbal/Language"
    value: TRUE
  eval_pri:
    label: "Visual Perception/Construction"
    value: TRUE
  eval_wmi:
    label: "Working Memory"
    value: TRUE
  eval_psi:
    label: "Processing Speed"
    value: TRUE
  match:
    label: "Subset/Match Rows"
    input: checkbox
    value: FALSE
output:
  rmdformats::robobook:
    highlight: kate
---

# WRAT-5

## Load libraries

```{r setup, include = FALSE}
Sys.setenv(
  JAVA_HOME =
    "/Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home"
)
options(java.parameters = "-Xmx16000m")
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = TRUE
)
library(bwu)
library(hablar)
library(here)
library(knitr)
library(readr)
library(rJava)
library(rmarkdown)
library(rmdformats)
library(shiny)
library(snakecase)
library(tabulizer)
library(tibble)
library(tidyr)
library(dplyr)
```

## Patient

```{r patient}
patient <- params$patient
```

## Test

```{r test}
test <- params$test
test_name <- params$test_name
```

## Upload/attach PDF

```{r choose}
# file <- file.choose()
# file <- params$file
file <- file.path(params$file)
```

## Pages

```{r pages}
pages <- params$pages
```

```{r write-file}
# writeLines(file, here::here(patient, "pre_csv", "wais4_pdf"))
```

```{r read-file}
# file <- readLines(here::here(patient, "pre_csv", "wais4_pdf"))
```

## Extract Areas with Tabulizer

```{r eval=FALSE}
library(tabulizer)

f <- file.path("/Users/joey/neuropsychology/Bridget/pdf/ADHD-MCAT Eval Young Adult-505986fe-aa3d-4a6b-8cfc-4e7c7f93129d.pdf")

# locate areas and extract
plucked_tables <- extract_areas(
  file = f,
  pages = c(8),
  method = "stream",
  output = "matrix"
)

# Loop over the list and write each matrix to a CSV file
test <- "wrat5"
for (i in seq_along(plucked_tables)) {
  write.csv(plucked_tables[[i]], file = paste0(test, "_", i, ".csv"), row.names = FALSE)
}

# Save the entire list to an R data file
save(plucked_tables, file = "plucked_tables_wrat5.RData")
```

## Locate areas

```{r areas-known, eval = FALSE}
# if known
area <- list(c(149, 53, 224, 559))
```

```{r write-area}
# saveRDS(
#   area,
#   file = here::here(patient, "pre_csv", "area_wais4.rds"),
#   compress = FALSE)
```

```{r read-area}
# area <- readRDS(here::here(patient, "pre_csv", "area_wais4.rds"))
# area <- list(area)
```

## Extract tables

```{r extract-tables, eval = FALSE}
plucked_tables <- bwu::gpluck_extract_table(
  file = file,
  pages = pages,
  area = area,
  guess = "FALSE",
  method = "stream",
  output = "matrix"
)

```

```{r}
# Load the entire list from an R data file
load("plucked_tables_wrat5.RData")
```

# WRAT-5 (Table 1)

## Pluck and tidy tables

```{r pluck1, eval = params$eval_iq}
# Assuming you have plucked_tables and params already defined

# Convert to data.frame
table <- as.data.frame(plucked_tables[[1]])

# Rename columns
colnames1 <- params[["colnames1"]]
colnames(table) <- colnames1

# Convert columns to double
to_double <- c("raw_score", "score", "percentile")
table[to_double] <- lapply(table[to_double], as.numeric)


table[, 1] <- (params$table)
table <- table |> dplyr::select(all_of(params$keep1))
```

## Mutate columns

```{r mutate1, eval = params$eval_iq}
domain <- "Academic Skills"
timed <- "Untimed"
table <- bwu::gpluck_make_columns(
  table,
  range = "",
  test = params$test,
  test_name = params$test_name,
  domain = domain,
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = timed,
  test_type = "npsych_test",
  score_type = "standard_score",
  description = "",
  result = ""
)
```

## Test score ranges

```{r range1, eval = params$eval_iq}
table <- bwu::gpluck_make_score_ranges(table = table, test_type = "npsych_test")
```

## Subdomains

```{r subdomains}
table <-
  table |>
  mutate(
    subdomain = case_when(
      scale == "Math Computation" ~ "Math",
      scale == "Spelling" ~ "Writing",
      scale == "Word Reading" ~ "Reading",
      scale == "Sentence Comprehension" ~ "Reading",
      scale == "Reading Composite" ~ "Reading",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r narrow}
table <-
  table |>
  mutate(
    narrow = case_when(
      scale == "Math Computation" ~ "Mathematical Achievement",
      scale == "Spelling" ~ "Spelling Ability",
      scale == "Word Reading" ~ "Reading Decoding",
      scale == "Sentence Comprehension" ~ "Reading Comprehension",
      scale == "Reading Composite" ~ "Reading Index",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS model

```{r pass}
table <-
  table |>
  mutate(
    pass = case_when(
      scale == "Math Computation" ~ "Simultaneous",
      scale == "Spelling" ~ "Sequential",
      scale == "Word Reading" ~ "Sequential",
      scale == "Sentence Comprehension" ~ "Sequential",
      scale == "Reading Composite" ~ "Sequential",
      TRUE ~ as.character(pass)
    )
  )
```

## Verbal vs Nonverbal

```{r verbal}
table <-
  table |>
  mutate(
    verbal = case_when(
      scale == "Math Computation" ~ "Nonverbal",
      scale == "Spelling" ~ "Verbal",
      scale == "Word Reading" ~ "Verbal",
      scale == "Sentence Comprehension" ~ "Verbal",
      scale == "Reading Composite" ~ "Verbal",
      TRUE ~ as.character(verbal)
    )
  )
```

## Timed vs Untimed

```{r timed}
table <-
  table |>
  mutate(
    timed = case_when(
      scale == "Math Computation" ~ "Timed",
      scale == "Spelling" ~ "Untimed",
      scale == "Word Reading" ~ "Untimed",
      scale == "Sentence Comprehension" ~ "Untimed",
      scale == "Reading Composite" ~ "Untimed",
      TRUE ~ as.character(timed)
    )
  )
```

## Scale descriptions

```{r description}
table <-
  table |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Math Computation" ~ "Paper-and-pencil math calculation",
      scale == "Spelling" ~ "Spelling words from dictations",
      scale == "Word Reading" ~ "Word reading/decoding on a word recognition test",
      scale == "Sentence Comprehension" ~ "Reading passage comprehension",
      scale == "Reading Composite" ~ "General reading performance",
      TRUE ~ as.character(description)
    )
  )
```

## Glue result

```{r result1}
table <-
  table |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale == "Math Computation" ~ glue::glue("{description} was {range} overall.\n"),
      scale == "Spelling" ~ glue::glue(
        "{description} was {range} and ranked at the {percentile}th percentile, indicating performance as good as or better than {percentile}% of same-age peers from the general population.\n"
      ),
      scale == "Word Reading" ~ glue::glue(
        "{description} was classified as {range} and ranked at the {percentile}th percentile.\n"
      ),
      scale == "Sentence Comprehension" ~ glue::glue(
        "{description} was classified as {range} and ranked at the {percentile}th percentile.\n"
      ),
      scale == "Reading Composite" ~ glue::glue(
        "{description} fell in the {range} range.\n"
      )
    )
  )
```

## Relocate variables

```{r relocate1, eval = params$eval_iq}
wrat5 <- table |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# Finalize and save csv

## Write out final csv

```{r write}
readr::write_csv(wrat5, here::here(patient, "csv", "wrat5.csv"))
```

# Experimental

## Write to "g"

```{r writeout-g}
table <- wrat5
test <- "g2"
file_path <- here::here(patient, "csv", paste0(test, ".csv"))
tidytable::fwrite(
  table,
  file_path,
  append = TRUE
)
```

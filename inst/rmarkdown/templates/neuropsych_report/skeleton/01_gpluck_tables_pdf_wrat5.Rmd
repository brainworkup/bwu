---
title: "Pluck tables from WRAT-5"
---

# WRAT-5 Setup

## Load libraries

```{r setup, include=FALSE}
Sys.setenv(JAVA_HOME = "/Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home")
options(java.parameters = "-Xmx16000m")
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = TRUE
)
library(bwu)
library(knitr)
library(xfun)
library(tabulizer)
library(tabulizerjars)
library(rJava)
library(shiny)
library(miniUI)
library(here)
library(pdftools)
library(tidyverse)
library(fs)
library(data.table)
library(magrittr)
library(kableExtra)
library(formattable)
library(DT)
library(ggiraph)
library(hablar)
library(tibble)
```

## Patient

```{r patient}
patient <- "Lauren"
```

## Test

```{r test}
test <- "wrat5"
```

## Pages

```{r}
pages <- c(8)
```

# TabulizeR

Need to check each PDF to see what page(s) tables are located on.

## File choose

```{r file}
wrat5_pdf <- file.choose()
```

```{r save}
readr::write_lines(wrat5_pdf, here::here(patient, "pre_csv", "wrat5_pdf"))
```

```{r read}
wrat5_pdf <- readr::read_lines(here::here(patient, "pre_csv", "wrat5_pdf"))
```

## Locate areas

```{r}
area <- list(c(149, 53, 224, 559))
```

```{r locate}
area <- bwu::gpluck_locate_areas(
  file = wrat5_pdf,
  pages = pages)
```

```{r save-areas}
readr::write_rds(area, here::here(patient, "pre_csv", "area_wrat5.rds"))
```

```{r}
area <- readr::read_rds(here::here(patient, "pre_csv", "area_wrat5.rds"))
```

### Extract table

Change pages per patient.

```{r extract}
plucked_table <- bwu::gpluck_extract_table(
  file = wrat5_pdf,
  pages = pages,
  area = area,
  guess = NULL,
  method = "stream",
  output = "matrix"
)
```

# Tidy Tables

## Column names per test/subtest/measure

This will vary by measure/table (e.g., GSV/NCE).

```{r}
column_names <- c(
  "scale",
  "raw_score",
  "score",
  "ci_95",
  "percentile",
  "category",
  "grade_equiv",
  "nce"
  # "gsv"
  )
```

## Convert to tibble and format

```{r to-tibble}
table <- as_tibble(plucked_table[[1]])
colnames(table) <- column_names
table <- dplyr::na_if(table, "")
table <- dplyr::na_if(table, "NA")
table <- dplyr::na_if(table, "-")
table <- dplyr::na_if(table, "--")
table <- dplyr::na_if(table, "---")
to_double <- c("raw_score", "score", "percentile")
table <- table |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames}
table[1, 1] <- c("Math Computation")
# table[2, 1] <- c("Spelling")
# table[3, 1] <- c("Word Reading")
# table[4, 1] <- c("Sentence Comprehension")
# table[5, 1] <- c("Reading Composite")
```

## Select variables to keep

This will vary by measure.

```{r keep}
keep <- c("scale", "raw_score", "score", "percentile", "ci_95")
table <- table |> select(all_of(keep))
```

# Classifications

## Mutate new columns in table

```{r mutate}
table <- bwu::gpluck_make_columns(
  table,
  range = "",
  test = "wrat5",
  test_name = "WRAT-5",
  domain = "Academic Skills",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "Untimed",
  test_type = "npsych_test",
  score_type = "standard_score",
  description = ""
)
```

## Test score ranges

```{r}
table <- gpluck_make_score_ranges(table = table, test_type = "npsych_test")
```

## Subdomains

```{r subdomains}
table <-
  table |>
  mutate(
    subdomain = case_when(
      scale == "Math Computation" ~ "Math",
      scale == "Spelling" ~ "Writing",
      scale == "Word Reading" ~ "Reading",
      scale == "Sentence Comprehension" ~ "Reading",
      scale == "Reading Composite" ~ "Reading",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r narrow}
table <-
  table |>
  mutate(
    narrow = case_when(
      scale == "Math Computation" ~ "Mathematical Achievement",
      scale == "Spelling" ~ "Spelling Ability",
      scale == "Word Reading" ~ "Reading Decoding",
      scale == "Sentence Comprehension" ~ "Reading Comprehension",
      scale == "Reading Composite" ~ "Reading Index",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS model

```{r pass}
table <-
  table |>
  mutate(
    pass = case_when(
      scale == "Math Computation" ~ "Simultaneous",
      scale == "Spelling" ~ "Successive",
      scale == "Word Reading" ~ "Successive",
      scale == "Sentence Comprehension" ~ "Successive",
      scale == "Reading Composite" ~ "Successive",
      TRUE ~ as.character(pass)
    )
  )
```

## Verbal vs Nonverbal

```{r verbal}
table <-
  table |>
  mutate(
    verbal = case_when(
      scale == "Math Computation" ~ "Nonverbal",
      scale == "Spelling" ~ "Verbal",
      scale == "Word Reading" ~ "Verbal",
      scale == "Sentence Comprehension" ~ "Verbal",
      scale == "Reading Composite" ~ "Verbal",
      TRUE ~ as.character(verbal)
    )
  )
```

## Timed vs Untimed

```{r timed}
table <-
  table |>
  mutate(
    timed = case_when(
      scale == "Math Computation" ~ "Timed",
      scale == "Spelling" ~ "Untimed",
      scale == "Word Reading" ~ "Untimed",
      scale == "Sentence Comprehension" ~ "Untimed",
      scale == "Reading Composite" ~ "Untimed",
      TRUE ~ as.character(timed)
    )
  )
```

## Scale descriptions

```{r description}
table <-
  table |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Math Computation" ~ "paper-and-pencil math calculation",
      scale == "Spelling" ~ "spelling words from dictations",
      scale == "Word Reading" ~ "word reading/decoding on a word recognition test",
      scale == "Sentence Comprehension" ~ "reading passage comprehension",
      scale == "Reading Composite" ~ "general reading performance",
      TRUE ~ as.character(description)
    )
  )
```

# Finalize and save

## Relocate variables

```{r relocate}
wrat5 <- table |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

## Write out final csv

```{r}
readr::write_csv(wrat5, here::here(patient, "csv", "wrat5.csv"), col_names = TRUE, na = "")
```

## Cleanup

```{r eval=T}
rm(table)
rm(area)
```

TODO Eventually add predicted achievement table if want.

---
title: "Plant CSV file of Neuropsych Measures/Tests"
params:
  patient:
    label: "Patient First Name:"
    value: Biggie
    input: text
  test_name:
    label: "Full Name of Test/Test Battery:"
    value: ""
    input: radio
    choices:
      - NIH EXAMINER
      - Rey Complex Figure
      - Test of Premorbid Functioning
      - Trail Making Test
      - D-KEFS Color-Word Interference
      - Grooved Pegboard
      - KTEA-3
      - NAB
      - WMS-IV
      - Cognitive Estimation Test
  test:
    label: "Test/Measure File Name:"
    value: ""
    input: radio
    choices:
      - examiner
      - rocft
      - topf
      - tmt
      - dkefs_cwi
      - pegboard
      - ktea3
      - nab
      - wms4
      - cet
  scale:
    label: "Scale/Subtest:"
    value: ""
    input: select
    choices:
      - Unstructured Task
      - Letter Fluency
      - Category Fluency
      - ROCFT Copy
      - ROCFT Delayed Recall
      - TOPF Standard Score
      - Dominant Hand
      - Nondominant Hand
      - Judgment
      - Trails A
      - Trails B
      - D-KEFS Color Naming
      - D-KEFS Word Reading
      - D-KEFS Inhibition
      - D-KEFS Switching
      - D-KEFS Inhibition Total Errors
      - D-KEFS Switching Total Errors
      - Nonsense Word Decoding
      - Decoding Fluency
      - Reading Comprehension
      - Symbol Span
      - Deviation Score
  raw_score:
    label: "Raw score:"
    value: 10
    input: numeric
  score:
    label: "Standardized score:"
    value: 50
    input: numeric
  score_type:
    label: "Type of Test Score:"
    value: ""
    input: radio
    choices:
      - z_score
      - scaled_score
      - t_score
      - standard_score
  domain:
    label: "Domain:"
    value: ""
    input: radio
    choices:
      - Intelligence/General Ability
      - Academic Skills
      - Verbal/Language
      - Visual Perception/Construction
      - Attention/Executive
      - Memory
      - Motor
      - Social Cognition
      - ADHD/Executive Functioning
      - Behavioral/Emotional/Social
      - Effort/Validity
  subdomain:
    label: "Subdomain:"
    value: ""
    input: radio
    choices:
      - Cognitive Control
      - Cognitive Flexibility
      - Concept Formation
      - Crystallized Intelligence
      - Delayed Recall
      - Everyday Executive
      - Fine Motor Dexterity
      - Fluency
      - Planning
      - Response Monitoring
      - Retrieval Fluency
      - Reading
      - Processing Speed
      - Working Memory
  narrow:
    label: "Narrow subdomain:"
    value: ""
    input: radio
    choices:
      - Abstract Reasoning
      - Decision-Making
      - Dominant Hand Dexterity
      - Inhibition
      - Judgment
      - Naming Facility
      - Nondominant Hand Dexterity
      - Perceptual Organization
      - Phonemic Fluency
      - Premorbid Ability
      - Problem-Solving
      - Response Monitoring
      - Semantic Fluency
      - Set-Shifting
      - Visual Memory
      - Reading Decoding
      - Reading Speed
      - Planning
      - Reading Comprehension
      - Psychomotor Speed
      - Cognitive Efficiency
      - Nonverbal Working Memory
  pass:
    label: "PASS:"
    value: ""
    input: radio
    choices:
      - Planning
      - Attention
      - Sequential
      - Simultaneous
      - Knowledge
  verbal:
    label: "Verbal or Nonverbal Test:"
    value: ""
    input: radio
    choices:
      - Verbal
      - Nonverbal
  timed:
    label: "Timed or Untimed Test:"
    value: ""
    input: radio
    choices:
      - Timed
      - Untimed
  mean:
    label: "Mean:"
    value: 50
    input: radio
    choices: [0, 10, 50, 100]
  stdev:
    label: "Standard Deviation:"
    value: 10
    input: radio
    choices: [1, 3, 10, 15]
  reliability:
    label: "Reliability:"
    value: 0.80
    input: slider
    min: 0
    max: 1
    step: 0.01
  percentile: NULL
  range: NULL
  ci_95: NULL
  test_type:
    label: "Test Type:"
    value: npsych_test
    input: radio
    choices:
      - npsych_test
      - rating_scale
  absort:
  description:
  result:
output:
  rmdformats::robobook:
    highlight: kate
---

## Setup

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  error = TRUE
)
library(bwu)
library(gt)
library(hablar)
library(here)
library(knitr)
library(magrittr)
library(readr)
library(rmarkdown)
library(shiny)
library(snakecase)
library(table.glue)
library(tibble)
library(tidyr)
library(tidytable)
library(vroom)
```

## Patient

```{r patient}
patient <- params$patient
```

## Make data.frame

```{r make-df}
df <- tidytable::tidytable(
  test = (params$test),
  test_name = (params$test_name),
  test_type = (params$test_type),
  scale = (params$scale),
  raw_score = as.numeric(params$raw_score),
  score = as.numeric(params$score),
  ci_95 = NA,
  score_adj = NA,
  ci_95_lower = NA,
  ci_95_upper = NA,
  percentile = NA,
  range = NA,
  range_lower = NA,
  range_upper = NA,
  score_type = (params$score_type),
  domain = (params$domain),
  subdomain = (params$subdomain),
  narrow = (params$narrow),
  pass = (params$pass),
  verbal = (params$verbal),
  timed = (params$timed),
  absort =
    paste0(
      tolower(params$test),
      "_", tolower(params$scale),
      "_", seq_len(1)
    ),
  description = NA,
  result = NA
)
```

## Function for scale description

```{r func-desc}
compute_desc <- function(.x, .scale, description, ...) {
  tidytable::mutate.(.x,
    description = tidytable::case_when.(
      .scale ==
        "ROCFT Copy" ~
        "Visuoconstructural drawing/copying of a complex figure requiring visuospatial integration, planning and organization, and efficient encoding of visuospatial material",
      .scale ==
        "ROCFT Delayed Recall" ~
        "Spontaneous, long-term delayed recall (20-25 min) recall and reproduction of a complex abstract figure",
      .scale ==
        "Judgment" ~
        "Judgment and decision-making in everyday situations",
      .scale == "D-KEFS Color Naming" ~
        "Rapid color naming",
      .scale == "D-KEFS Word Reading" ~
        "Rapid word reading",
      .scale == "D-KEFS Inhibition" ~
        "Inhibition/cognitive control",
      .scale == "D-KEFS Switching" ~
        "Set-shifting/cognitive flexibility",
      .scale == "D-KEFS Inhibition Total Errors" ~
        "Response monitoring during an inhibition task",
      .scale == "D-KEFS Switching Total Errors" ~
        "Response monitoring during a set-shifting task",
      .scale == "Dominant Hand" ~
        "Fine-motor dexterity (dominant hand)",
      .scale == "Nondominant Hand" ~
        "Nondominant hand dexterity",
      .scale == "TOPF Standard Score" ~
        "An estimate of premorbid verbal ability level",
      .scale == "Unstructured Task" ~
        "Strategic planning and organization aptitude to formulate an action in advance of performance or intended performance",
      .scale == "Letter Fluency" ~
        "Letter/phonemic word fluency",
      .scale == "Category Fluency" ~
        "Categorical/semantic word fluency",
      .scale == "Deviation Score" ~
        "Abstract reasoning (hypothesis generation and concept formation)",
      .scale == "Nonsense Word Decoding" ~
        "Phonic decoding skills as assessed by reading aloud a list of pseudowords",
      .scale == "Decoding Fluency" ~
        "Phonic decoding fluency",
      .scale == "Reading Comprehension" ~
        "Reading comprehension skills at the level of the word, sentence, and passage",
      .scale == "Trails A" ~
        "Rapid numerical sequencing and psychomotor speed",
      .scale == "Trails B" ~
        "Rapid number-to-letter sequencing/switching and divided attention",
      .scale == "Symbol Span" ~
        "Nonverbal working memory",
      TRUE ~ as.character(description)
    )
  )
}
```

```{r compute-desc}
df1 <- compute_desc(.x = df, .scale = df$scale, description = description)
```

## Function to compute percentile and range

```{r func-pr}
compute_pctile_range <-
  function(.x,
           .score = NA,
           .score_type =
             c("z_score", "scaled_score", "t_score", "standard_score"),
           percentile = NA,
           range = NA,
           .pct1 = NA,
           .pct2 = NA,
           .pct3 = NA,
           z = NA,
           ...) {
    if (.score_type == "z_score") {
      .x <-
        .x |>
        tidytable::mutate.(z = (.score - 0) / 1) %>%
        tidytable::mutate.(.pct1 = round(stats::pnorm(z) * 100, 1)) %>%
        tidytable::mutate.(.pct2 = tidytable::case_when.(
          .pct1 < 1 ~ ceiling(.pct1),
          .pct1 > 99 ~ floor(.pct1),
          TRUE ~ round(.pct1)
        )) %>%
        tidytable::mutate.(.pct3 = .pct2) %>%
        tidytable::mutate.(
          range = tidytable::case_when.(
            .pct3 >= 98 ~ "Exceptionally High",
            .pct3 %in% 91:97 ~ "Above Average",
            .pct3 %in% 75:90 ~ "High Average",
            .pct3 %in% 25:74 ~ "Average",
            .pct3 %in% 9:24 ~ "Low Average",
            .pct3 %in% 2:8 ~ "Below Average",
            .pct3 < 2 ~ "Exceptionally Low",
            TRUE ~ as.character(range)
          )
        ) %>%
        tidytable::mutate.(percentile = .pct1) %>%
        tidytable::select.(-c(.pct1, .pct2, .pct3))
    } else if (.score_type == "scaled_score") {
      .x <-
        .x |>
        tidytable::mutate.(z = (.score - 10) / 3) %>%
        tidytable::mutate.(.pct1 = round(stats::pnorm(z) * 100, 1)) %>%
        tidytable::mutate.(.pct2 = tidytable::case_when.(
          .pct1 < 1 ~ ceiling(.pct1),
          .pct1 > 99 ~ floor(.pct1),
          TRUE ~ round(.pct1)
        )) %>%
        tidytable::mutate.(.pct3 = .pct2) %>%
        tidytable::mutate.(
          range = tidytable::case_when.(
            .pct3 >= 98 ~ "Exceptionally High",
            .pct3 %in% 91:97 ~ "Above Average",
            .pct3 %in% 75:90 ~ "High Average",
            .pct3 %in% 25:74 ~ "Average",
            .pct3 %in% 9:24 ~ "Low Average",
            .pct3 %in% 2:8 ~ "Below Average",
            .pct3 < 2 ~ "Exceptionally Low",
            TRUE ~ as.character(range)
          )
        ) %>%
        tidytable::mutate.(percentile = .pct1) %>%
        tidytable::select.(-c(.pct1, .pct2, .pct3))
    } else if (.score_type == "t_score") {
      .x <-
        .x |>
        tidytable::mutate.(z = (.score - 50) / 10) %>%
        tidytable::mutate.(.pct1 = round(stats::pnorm(z) * 100, 1)) %>%
        tidytable::mutate.(.pct2 = tidytable::case_when.(
          .pct1 < 1 ~ ceiling(.pct1),
          .pct1 > 99 ~ floor(.pct1),
          TRUE ~ round(.pct1)
        )) %>%
        tidytable::mutate.(.pct3 = .pct2) %>%
        tidytable::mutate.(
          range = tidytable::case_when.(
            .pct3 >= 98 ~ "Exceptionally High",
            .pct3 %in% 91:97 ~ "Above Average",
            .pct3 %in% 75:90 ~ "High Average",
            .pct3 %in% 25:74 ~ "Average",
            .pct3 %in% 9:24 ~ "Low Average",
            .pct3 %in% 2:8 ~ "Below Average",
            .pct3 < 2 ~ "Exceptionally Low",
            TRUE ~ as.character(range)
          )
        ) %>%
        tidytable::mutate.(percentile = .pct1) %>%
        tidytable::select.(-c(.pct1, .pct2, .pct3))
    } else if (.score_type == "standard_score") {
      .x <-
        .x |>
        tidytable::mutate.(z = (.score - 100) / 15) %>%
        tidytable::mutate.(.pct1 = round(stats::pnorm(z) * 100, 1)) %>%
        tidytable::mutate.(.pct2 = tidytable::case_when.(
          .pct1 < 1 ~ ceiling(.pct1),
          .pct1 > 99 ~ floor(.pct1),
          TRUE ~ round(.pct1)
        )) %>%
        tidytable::mutate.(.pct3 = .pct2) %>%
        tidytable::mutate.(
          range = tidytable::case_when.(
            .pct3 >= 98 ~ "Exceptionally High",
            .pct3 %in% 91:97 ~ "Above Average",
            .pct3 %in% 75:90 ~ "High Average",
            .pct3 %in% 25:74 ~ "Average",
            .pct3 %in% 9:24 ~ "Low Average",
            .pct3 %in% 2:8 ~ "Below Average",
            .pct3 < 2 ~ "Exceptionally Low",
            TRUE ~ as.character(range)
          )
        ) %>%
        tidytable::mutate.(percentile = .pct1) %>%
        tidytable::select.(-c(.pct1, .pct2, .pct3))
    }
  }
```

## Compute percentile, range

```{r compute-pr}
df2 <- compute_pctile_range(
  .x = df1,
  .score = df1$score,
  .score_type = df1$score_type,
  percentile = percentile,
  range = range
)
```

## Function to compute and glue result

```{r func-result}
compute_result <-
  function(.x,
           .scale,
           .description,
           .range,
           result,
           ...) {
    .x <-
      tidytable::mutate.(
        .x,
        result = tidytable::case_when.(
          .scale == "ROCFT Copy" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "ROCFT Delayed Recall" ~
            glue::glue("{.description} fell within the {.range} range.\n"),
          .scale == "Judgment" ~
            glue::glue("{.description} fell within the {.range} range.\n"),
          .scale == "D-KEFS Color Naming" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "D-KEFS Word Reading" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "D-KEFS Inhibition" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "D-KEFS Switching" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "D-KEFS Inhibition Total Errors" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "D-KEFS Switching Total Errors" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "Dominant Hand" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "Nondominant Hand" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "TOPF Standard Score" ~
            glue::glue("{.description} fell within the {.range} range.^[(ref:premorbid)]\n"),
          .scale == "Unstructured Task" ~
            glue::glue("{.description} fell within the {.range} range.\n"),
          .scale == "Letter Fluency" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "Category Fluency" ~
            glue::glue("{.description} fell within the {.range} range.\n"),
          .scale == "Deviation Score" ~
            glue::glue("{.description} fell within the {.range} range.\n"),
          .scale == "Nonsense Word Decoding" ~
            glue::glue("{.description} were {.range}.\n"),
          .scale == "Decoding Fluency" ~
            glue::glue("{.description} fell within the {.range} range.\n"),
          .scale == "Reading Comprehension" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "Trails A" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "Trails B" ~
            glue::glue("{.description} was {.range}.\n"),
          .scale == "Symbol Span" ~
            glue::glue("{.description} was {.range}.\n"),
          TRUE ~ as.character(result)
        )
      )
  }
```

```{r compute-result}
.description <- (df2$description)
.range <- (df2$range)
df3 <- compute_result(
  .x = df2,
  .scale = df2$scale,
  .description = .description,
  .range = .range
)
```

## Compute CI 95%

```{r ci95}
df3$ci_95 <- bwu::ci(
  x = as.numeric(df3$score),
  m = as.numeric(params$mean),
  sd = as.numeric(params$stdev),
  rel = as.numeric(params$reliability)
)
```

## Write out CSV

```{r writeout-scale}
table <- df3
test <- table$test
scale <- to_snake_case(table$scale)
tidytable::fwrite.(
  table,
  here::here(patient, "pre_csv", paste0(test, "_", scale, ".csv")),
  append = FALSE
)
```

```{r writeout-test}
table <- df3
test <- table$test
tidytable::fwrite.(
  table,
  here::here(patient, "csv", paste0(test, ".csv")),
  append = TRUE
)
```

```{r writeout-g}
table <- df3
test <- "g"
tidytable::fwrite.(
  table,
  here::here(patient, "csv", paste0(test, ".csv")),
  append = TRUE
)
```

---
title: "Pluck Tables from WAIS-IV"
params:
  patient: "Biggie"
  test:
    label: "Test"
    value: wais4
    input: select
    multiple: no
    choices:
      - wais4
      - wisc5
  test_name:
    label: "Test Name"
    value: WAIS-IV
    input: select
    multiple: no
    choices:
      - WAIS-IV
      - WISC-V
  file:
    label: "No file selected"
    value: file
    input: file
  pages: [2,4,4,4,4,6,6]
  table1:
    label: "Index Scores"
    value: Verbal Comprehension (VCI)
    input: select
    multiple: yes
    choices:
      - Verbal Comprehension (VCI)
      - Perceptual Reasoning (PRI)
      - Working Memory (WMI)
      - Processing Speed (PSI)
      - Full Scale IQ (FSIQ)
      - General Ability (GAI)
  table2:
    label: "Verbal Comprehension (VCI)"
    value: Similarities
    input: select
    multiple: yes
    choices:
      - Similarities
      - Vocabulary
      - Information
      - Comprehension
  table3:
    label: "Perceptual Reasoning (PRI)"
    value: Block Design
    input: select
    multiple: yes
    choices:
      - Block Design
      - Matrix Reasoning
      - Visual Puzzles
      - Figure Weights
  table4:
    label: "Working Memory (WMI)"
    value: Digit Span
    input: select
    multiple: yes
    choices:
      - Digit Span
      - Arithmetic
      - Letter-Number Sequencing
  table5:
    label: "Processing Speed (PSI)"
    value: Symbol Search
    input: select
    multiple: yes
    choices:
      - Symbol Search
      - Coding
      - Cancellation
  table6:
    label: "Perceptual Reasoning Process Score Summary"
    value: Block Design No Time Bonus
    input: select
    multiple: yes
    choices:
      - Block Design No Time Bonus
  table7:
    label: "Working Memory Process Score Summary"
    value: Digit Span Forward
    input: select
    multiple: yes
    choices:
      - Digit Span Forward
      - Digit Span Backward
      - Digit Span Sequencing
      - Longest Digit Span Forward
      - Longest Digit Span Backward
      - Longest Digit Span Sequence
      - Longest Letter-Number Sequence
  colnames1:
    label: "Table 1 Column Names"
    value: scale
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - abbrev
      - score
      - percentile
      - ci_95
      - category
  colnames2:
    label: "Tables 2-5 Column Names"
    value: scale
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - ref_group_ss
      - sem
  colnames3:
    label: "Table 6 Column Names"
    value: scale
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - sem
  colnames4:
    label: "Table 7 Column Names"
    value: scale
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - base_rate
      - sem
  keep1:
    label: "Variables to Keep, Set 1"
    value: scale
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - ci_95
  keep2:
    label: "Variables to Keep, Set 2"
    value: scale
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
---

# WAIS-IV

## Load libraries

```{r setup, include=FALSE}
Sys.setenv(JAVA_HOME = "/Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home")
options(java.parameters = "-Xmx16000m")
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = TRUE
)
library(bwu)
library(dplyr)
library(hablar)
library(here)
library(knitr)
library(magrittr)
library(miniUI)
library(readr)
library(rJava)
library(rmarkdown)
library(shiny)
library(tabulizer)
library(tabulizerjars)
library(tibble)
library(tidyr)
library(vroom)
```

## Patient

```{r patient}
patient <- params$patient
```

## Test

```{r test}
test <- params$test
```

## Upload/attach PDF

```{r choose}
file <- params$file
```

## Pages

```{r pages}
pages <- params$pages
```

```{r w-file}
writeLines(file, here::here(patient, "pre_csv", "wais4_pdf"))
```

```{r r-file}
file <- readLines(here::here(patient, "pre_csv", "wais4_pdf"))
```

## Locate areas

```{r areas-known}
# if known
area <- list(
  index = c(133, 50, 212, 560),
  vci = c(347, 50, 382, 560),
  pri = c(434, 50, 468, 560),
  wmi = c(521, 50, 553, 560),
  psi = c(605, 50, 639, 560),
  bd = c(377, 50, 398, 560),
  ds = c(460, 50, 570, 560)
)
```

```{r areas-get, eval=FALSE}
# if unknown
# patient <- "Biggie"
# file <- file.choose()
# area <- bwu::gpluck_locate_areas(
#   file = file,
#   pages = c(2,4,4,4,4,6,6)
# )
```

```{r w-area}
saveRDS(area, file = here::here(patient, "pre_csv", "area_wais4.rds"), compress = FALSE)
```

```{r r-area}
area <- readRDS(here::here(patient, "pre_csv", "area_wais4.rds"))
```

## Extract tables

```{r extract}
plucked_table <- bwu::gpluck_extract_table(
  file = file,
  pages = pages,
  area = area,
  guess = NULL,
  method = "stream",
  output = "matrix"
)
```

# Index Scores (Table 1)

## Pluck and tidy tables

```{r pluck1}
table1 <- tibble::as_tibble(plucked_table[[1]])
colnames(table1) <- params$colnames1
table1 <- dplyr::na_if(table1, "")
table1 <- dplyr::na_if(table1, "NA")
table1 <- dplyr::na_if(table1, "-")
table1 <- dplyr::na_if(table1, "--")
table1 <- dplyr::na_if(table1, "---")
to_double <- c("raw_score", "score", "percentile")
table1 <- table1 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames1}
table1$scale <- params$table1
```

## Select variables to keep

```{r select1}
table1 <- table1 |> dplyr::select(all_of(params$keep1))
```

## Mutate columns

```{r mutate1}
table1 <- bwu::gpluck_make_columns(
  table1,
  range = "",
  test = params$test,
  test_name = params$test_name,
  domain = "",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "",
  test_type = "npsych_test",
  score_type = "standard_score",
  description = ""
)
```

## Domains

```{r domain1}
table1 <-
  table1 |>
  dplyr::mutate(
    domain = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Intelligence/General Ability",
      scale == "Perceptual Reasoning (PRI)" ~ "Intelligence/General Ability",
      scale == "Working Memory (WMI)" ~ "Intelligence/General Ability",
      scale == "Processing Speed (PSI)" ~ "Intelligence/General Ability",
      scale == "Full Scale IQ (FSIQ)" ~ "Intelligence/General Ability",
      scale == "General Ability (GAI)" ~ "Intelligence/General Ability",
      TRUE ~ as.character(domain)
    )
  )
```

## Subdomain

```{r subdomain1}
table1 <-
  table1 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Crystallized Intelligence",
      scale == "Perceptual Reasoning (PRI)" ~ "Fluid Intelligence",
      scale == "Working Memory (WMI)" ~ "Working Memory",
      scale == "Processing Speed (PSI)" ~ "Processing Speed",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence",
      scale == "General Ability (GAI)" ~ "General Intelligence",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomain

```{r narrow1}
table1 <-
  table1 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Crystallized Intelligence",
      scale == "Perceptual Reasoning (PRI)" ~ "Fluid Intelligence",
      scale == "Working Memory (WMI)" ~ "Working Memory",
      scale == "Processing Speed (PSI)" ~ "Processing Speed",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence",
      scale == "General Ability (GAI)" ~ "General Intelligence",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS model

```{r pass1}
table1 <-
  table1 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "",
      scale == "Perceptual Reasoning (PRI)" ~ "",
      scale == "Working Memory (WMI)" ~ "",
      scale == "Processing Speed (PSI)" ~ "",
      scale == "Full Scale IQ (FSIQ)" ~ "",
      scale == "General Ability (GAI)" ~ "",
      TRUE ~ as.character(pass)
    )
  )
```

## Verbal vs Nonverbal

```{r verbal1}
table1 <-
  table1 |>
  dplyr::mutate(
    verbal = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Verbal",
      scale == "Perceptual Reasoning (PRI)" ~ "Nonverbal",
      scale == "Working Memory (WMI)" ~ "Verbal",
      scale == "Processing Speed (PSI)" ~ "Nonverbal",
      scale == "Full Scale IQ (FSIQ)" ~ "",
      scale == "General Ability (GAI)" ~ "",
      TRUE ~ as.character(verbal)
    )
  )
```

## Timed vs Untimed

```{r timed1}
table1 <-
  table1 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Untimed",
      scale == "Perceptual Reasoning (PRI)" ~ "Timed",
      scale == "Working Memory (WMI)" ~ "Untimed",
      scale == "Processing Speed (PSI)" ~ "Timed",
      scale == "Full Scale IQ (FSIQ)" ~ "",
      scale == "General Ability (GAI)" ~ "",
      TRUE ~ as.character(timed)
    )
  )
```

## Scale descriptions

```{r desc1}
table1 <-
  table1 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "The VCI provides an estimate of Crystallized Intelligence (Gc). Gc refers to an individual's knowledge base (or general fund of information) that develops as a result of exposure to language, culture, general life experiences, and formal schooling.",
      scale == "Perceptual Reasoning (PRI)" ~ "The PRI provides an estimate of Fluid Reasoning (Gf). Gf refers to a type of thinking that an individual may use when faced with a relatively new or novel task that cannot be performed automatically.",
      scale == "Working Memory (WMI)" ~ "The WMI provides an estimate of Short-term Working Memory (Gsm). Gsm refers to the ability to hold information in immediate awareness and then manipulate or transform it in some way within a few seconds.",
      scale == "Processing Speed (PSI)" ~ "The PSI provides an estimate of Processing Speed (Gs). Gs refers to the efficiency of cognitive processing or speed of mental activity. It involves the ability to perform simple clerical-type tasks quickly, especially when under pressure to maintain attention and concentration.",
      scale == "Full Scale IQ (FSIQ)" ~ "general level of intellectual functioning",
      scale == "General Ability (GAI)" ~ "a subset of intellectual functioning with reduced influences of working memory and processing speed",
      TRUE ~ as.character(description)
    )
  )
```

## Test score ranges

```{r range1}
table1 <- bwu::gpluck_make_score_ranges(table = table1, test_type = "npsych_test")
```

## Relocate variables

```{r relocate1}
table1 <- table1 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# VCI (Table 2)

## Pluck and tidy tables

```{r pluck2}
table2 <- tibble::as_tibble(plucked_table[[2]])
colnames(table2) <- params$colnames2
table2 <- dplyr::na_if(table2, "")
table2 <- dplyr::na_if(table2, "NA")
table2 <- dplyr::na_if(table2, "-")
table2 <- dplyr::na_if(table2, "--")
table2 <- dplyr::na_if(table2, "---")
to_double <- c("raw_score", "score", "percentile")
table2 <- table2 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames2}
table2$scale <- params$table2
```

## Select variables to keep

```{r keep2}
table2 <- table2 |> dplyr::select(all_of(params$keep2))
```

## Mutate columns

```{r mutate2}
table2 <- bwu::gpluck_make_columns(
  table2,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Verbal/Language",
  subdomain = "",
  narrow = "",
  pass = "Sequential",
  verbal = "Verbal",
  timed = "Untimed",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

## Test score ranges

```{r ranges2}
table2 <- bwu::gpluck_make_score_ranges(table = table2, test_type = "npsych_test")
```

## Subdomains

```{r subdomain2}
table2 <-
  table2 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Similarities" ~ "Acquired Knowledge",
      scale == "Vocabulary" ~ "Acquired Knowledge",
      scale == "Information" ~ "Acquired Knowledge",
      scale == "Comprehension" ~ "Acquired Knowledge",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r narrow2}
table2 <-
  table2 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Similarities" ~ "Verbal Reasoning",
      scale == "Vocabulary" ~ "Lexical Knowledge",
      scale == "Information" ~ "General Verbal Information",
      scale == "Comprehension" ~ "General Verbal Information",
      TRUE ~ as.character(narrow)
    )
  )
```

## Scale descriptions

```{r desc2}
table2 <-
  table2 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Similarities" ~ "reasoning with words",
      scale == "Vocabulary" ~ "word knowledge",
      scale == "Information" ~ "acquired knowledge/ability to acquire, retain, and retrieve general factual knowledge",
      scale == "Comprehension" ~ "practical knowledge and judgment of general principles and social situations",
      TRUE ~ as.character(description)
    )
  )
```

## Relocate variables

```{r reloc2}
table2 <- table2 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# PRI (Table 3)

## Pluck and tidy tables

```{r pluck3}
table3 <- tibble::as_tibble(plucked_table[[3]])
colnames(table3) <- params$colnames2
table3 <- dplyr::na_if(table3, "")
table3 <- dplyr::na_if(table3, "NA")
table3 <- dplyr::na_if(table3, "-")
table3 <- dplyr::na_if(table3, "--")
table3 <- dplyr::na_if(table3, "---")
to_double <- c("raw_score", "score", "percentile")
table3 <- table3 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames3}
table3$scale <- params$table3
```

## Select variables to keep

```{r keep3}
table3 <- table3 |> dplyr::select(all_of(params$keep2))
```

## Mutate columns

```{r mutate3}
table3 <- bwu::gpluck_make_columns(
  table3,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Visual Perception/Construction",
  subdomain = "",
  narrow = "",
  timed = "",
  verbal = "Nonverbal",
  pass = "Simultaneous",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

## Test score ranges

```{r ranges3}
table3 <- bwu::gpluck_make_score_ranges(table = table3, test_type = "npsych_test")
```

## Subdomains

```{r subdomain3}
table3 <-
  table3 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Block Design" ~ "Visual Processing",
      scale == "Matrix Reasoning" ~ "Fluid Reasoning",
      scale == "Visual Puzzles" ~ "Visual Processing",
      scale == "Figure Weights" ~ "Fluid Reasoning",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomain

```{r narrow3}
table3 <-
  table3 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Block Design" ~ "Visuoconstruction",
      scale == "Matrix Reasoning" ~ "Inductive Reasoning",
      scale == "Visual Puzzles" ~ "Visualization",
      scale == "Figure Weights" ~ "General Sequential Reasoning",
      TRUE ~ as.character(narrow)
    )
  )
```

## Timed vs Untimed

```{r timed3}
table3 <-
  table3 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale == "Block Design" ~ "Timed",
      scale == "Matrix Reasoning" ~ "Untimed",
      scale == "Visual Puzzles" ~ "Timed",
      scale == "Figure Weights" ~ "Timed",
      TRUE ~ as.character(timed)
    )
  )
```

## Description

```{r desc3}
table3 <-
  table3 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Block Design" ~ "understand visual-spatial relationships to construct geometric designs from a model",
      scale == "Matrix Reasoning" ~ "inductive reasoning",
      scale == "Visual Puzzles" ~ "generate visual images in the mind's eye",
      scale == "Figure Weights" ~ "general sequential (deductive) reasoning and quantitative reasoning",
      TRUE ~ as.character(description)
    )
  )
```

## Relocate variables

```{r reloc3}
table3 <- table3 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# WMI (Table 4)

## Pluck and tidy tables

```{r pluck4}
table4 <- tibble::as_tibble(plucked_table[[4]])
colnames(table4) <- params$colnames2
table4 <- dplyr::na_if(table4, "")
table4 <- dplyr::na_if(table4, "NA")
table4 <- dplyr::na_if(table4, "-")
table4 <- dplyr::na_if(table4, "--")
table4 <- dplyr::na_if(table4, "---")
to_double <- c("raw_score", "score", "percentile")
table4 <- table4 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames4}
table4$scale <- params$table4
```

## Select variables to keep

```{r keep4}
table4 <- table4 |> dplyr::select(all_of(params$keep2))
```

## Mutate columns

```{r mutate4}
table4 <- bwu::gpluck_make_columns(
  table4,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Attention/Executive",
  subdomain = "Working Memory",
  narrow = "",
  pass = "Attention",
  verbal = "Verbal",
  timed = "Untimed",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

## Test score ranges

```{r ranges4}
table4 <- bwu::gpluck_make_score_ranges(table = table4, test_type = "npsych_test")
```

## Subdomains

```{r subdomain4}
table4 <-
  table4 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Digit Span" ~ "Working Memory",
      scale == "Arithmetic" ~ "Working Memory",
      scale == "Letter-Number Sequencing" ~ "Working Memory",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r narrow4}
table4 <-
  table4 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Digit Span" ~ "Working Memory",
      scale == "Arithmetic" ~ "Working Memory",
      scale == "Letter-Number Sequencing" ~ "Working Memory",
      TRUE ~ as.character(narrow)
    )
  )
```

## Timed vs Untimed

```{r timed4}
table4 <-
  table4 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale == "Digit Span" ~ "Untimed",
      scale == "Arithmetic" ~ "Timed",
      scale == "Letter-Number Sequencing" ~ "Untimed",
      TRUE ~ as.character(timed)
    )
  )
```

## PASS model

```{r pass4}
table4 <-
  table4 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale == "Digit Span" ~ "Attention",
      scale == "Arithmetic" ~ "Attention",
      scale == "Letter-Number Sequencing" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

## Scale descriptions

```{r desc4}
table4 <-
  table4 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Digit Span" ~ "register, maintain, and manipulate auditory information",
      scale == "Arithmetic" ~ "solve math word problems in working memory",
      scale == "Letter-Number Sequencing" ~ "register, maintain, manipulate, and resequence series of numbers and letters in working memory",
      TRUE ~ as.character(description)
    )
  )
```

## Relocate variables

```{r reloc4}
table4 <- table4 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# PSI (Table 5)

## Pluck and tidy tables

```{r pluck5}
table5 <- tibble::as_tibble(plucked_table[[5]])
colnames(table5) <- params$colnames2
table5 <- dplyr::na_if(table5, "")
table5 <- dplyr::na_if(table5, "NA")
table5 <- dplyr::na_if(table5, "-")
table5 <- dplyr::na_if(table5, "--")
table5 <- dplyr::na_if(table5, "---")
to_double <- c("raw_score", "score", "percentile")
table5 <- table5 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames5}
table5$scale <- params$table5
```

## Select variables to keep

```{r keep5}
table5 <- table5 |> dplyr::select(all_of(params$keep2))
```

## Mutate columns

```{r mutate5}
table5 <- bwu::gpluck_make_columns(
  table5,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Attention/Executive",
  subdomain = "Processing Speed",
  narrow = "",
  pass = "Planning",
  verbal = "Nonverbal",
  timed = "Timed",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

## Test score ranges

```{r ranges5}
table5 <- bwu::gpluck_make_score_ranges(table = table5, test_type = "npsych_test")
```

## Subdomains

```{r subdomain5}
table5 <-
  table5 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Coding" ~ "Processing Speed",
      scale == "Symbol Search" ~ "Processing Speed",
      scale == "Cancellation" ~ "Processing Speed",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r narrow5}
table5 <-
  table5 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Coding" ~ "Cognitive Efficiency",
      scale == "Symbol Search" ~ "Perceptual Speed",
      scale == "Cancellation" ~ "Visual Attention",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS model

```{r pass5}
table5 <-
  table5 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale == "Cancellation" ~ "Attention",
      scale == "Coding" ~ "Planning",
      scale == "Symbol Search" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

## Scale descriptions

```{r desc5}
table5 <-
  table5 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Coding" ~ "psychomotor speed, visual scanning ability, and visual-motor coordination",
      scale == "Symbol Search" ~ "visual-perceptual/decision-making speed",
      scale == "Cancellation" ~ "selective visual attention, visual discrimination, and visual-perceptual processing",
      TRUE ~ as.character(description)
    )
  )
```

## Relocate variables

```{r relocate5}
table5 <- table5 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# PRI Process Score Summary (Table 6)

## Pluck and tidy tables

```{r pluck6}
table6 <- tibble::as_tibble(plucked_table[[6]])
colnames(table6) <- params$colnames3
table6 <- dplyr::na_if(table6, "")
table6 <- dplyr::na_if(table6, "NA")
table6 <- dplyr::na_if(table6, "-")
table6 <- dplyr::na_if(table6, "--")
table6 <- dplyr::na_if(table6, "---")
to_double <- c("raw_score", "score", "percentile")
table6 <- table6 %>% hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames6}
table6$scale <- params$table6
```

## Select variables to keep

```{r keep6}
table6 <- table6 %>% dplyr::select(all_of(params$keep2))
```

## Mutate columns

```{r mutate6}
table6 <- bwu::gpluck_make_columns(
  table6,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Visual Perception/Construction",
  subdomain = "Visual Processing",
  narrow = "Visuoconstruction (Untimed)",
  timed = "Untimed",
  verbal = "Nonverbal",
  pass = "Simultaneous",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = ""
)
```

## Test score ranges

```{r ranges6}
table6 <- bwu::gpluck_make_score_ranges(table = table6, test_type = "npsych_test")
```

## Scale descriptions

```{r desc6}
table6 <-
  table6 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Block Design No Time Bonus" ~ "understand visual-spatial relationships to construct geometric designs from a model (untimed)",
      TRUE ~ as.character(description)
    )
  )
```

## Relocate variables

```{r relocate6}
table6 <- table6 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# WMI Process Score Summary (Table 7)

## Pluck and tidy tables

```{r pluck7}
table7 <- tibble::as_tibble(plucked_table[[7]])
colnames(table7) <- params$colnames4
table7 <- dplyr::na_if(table7, "")
table7 <- dplyr::na_if(table7, "NA")
table7 <- dplyr::na_if(table7, "-")
table7 <- dplyr::na_if(table7, "--")
table7 <- dplyr::na_if(table7, "---")
to_double <- c("raw_score", "score", "percentile")
table7 <- table7 |> hablar::convert(dbl(all_of(to_double)))
```

## Scale names

```{r rownames7}
table7$scale <- params$table7
```

## Variables to keep

```{r keep7}
table7 <- table7 |> dplyr::select(all_of(params$keep2))
```

## Mutate columns

```{r mutate7}
table7 <- bwu::gpluck_make_columns(
  table7,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Attention/Executive",
  subdomain = "Working Memory",
  narrow = "",
  pass = "",
  verbal = "Verbal",
  timed = "Untimed",
  test_type = "npsych_test",
  score_type = "",
  description = ""
)
```

## Test score ranges

```{r ranges7}
table7 <- bwu::gpluck_make_score_ranges(table = table7, test_type = "npsych_test")
```

## Narrow subdomains

```{r narrow7}
table7 <-
  table7 %>% 
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Digit Span Forward" ~ "Memory Span",
      scale == "Digit Span Backward" ~ "Working Memory",
      scale == "Digit Span Sequencing" ~ "Working Memory",
      scale == "Longest Digit Span Forward" ~ "Memory Span",
      scale == "Longest Digit Span Backward" ~ "Working Memory",
      scale == "Longest Digit Span Sequence" ~ "Working Memory",
      scale == "Longest Letter-Number Sequence" ~ "Working Memory",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS model

```{r pass7}
table7 <-
  table7 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale == "Digit Span Forward" ~ "Sequential",
      scale == "Digit Span Backward" ~ "Attention",
      scale == "Digit Span Sequencing" ~ "Attention",
      scale == "Longest Digit Span Forward" ~ "Sequential",
      scale == "Longest Digit Span Backward" ~ "Attention",
      scale == "Longest Digit Span Sequence" ~ "Attention",
      scale == "Longest Letter-Number Sequence" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

## Score type

```{r score7}
table7 <-
  table7 |>
  dplyr::mutate(
    score_type = dplyr::case_when(
      scale == "Digit Span Forward" ~ "scaled_score",
      scale == "Digit Span Backward" ~ "scaled_score",
      scale == "Digit Span Sequencing" ~ "scaled_score",
      scale == "Longest Digit Span Forward" ~ "raw_score",
      scale == "Longest Digit Span Backward" ~ "raw_score",
      scale == "Longest Digit Span Sequence" ~ "raw_score",
      scale == "Longest Letter-Number Sequence" ~ "raw_score",
      TRUE ~ as.character(score_type)
    )
  )
```

## Scale descriptions

```{r desc7}
table7 <-
  table7 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Digit Span Forward" ~ "recall of digits forward",
      scale == "Digit Span Backward" ~ "recall of digits backward",
      scale == "Digit Span Sequencing" ~ "recall of digits sequencing",
      scale == "Longest Digit Span Forward" ~ "recall of digits forward (span)",
      scale == "Longest Digit Span Backward" ~ "recall of digits backward (span)",
      scale == "Longest Digit Span Sequence" ~ "recall of digits sequence (span)",
      scale == "Longest Letter-Number Sequence" ~ "longest letter-number sequence (span)",
      TRUE ~ as.character(description)
    )
  )
```

## Relocate variables

```{r relocate7}
table7 <- table7 |> dplyr::relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```

# Finalize and save csv

## Merge tables

```{r merge}
wais4 <-
  dplyr::bind_rows(table1, table2, table3, table6, table4, table7, table5)
```

## Glue results

```{r result}
wais4 <-
  wais4 %>%
  dplyr::mutate(
    result = glue::glue(
      "{description} as measured by the {scale} subtest was {range} relative to same-age peers."
    )
  )
```

## Slice to reorder subtests/scales

```{r slice}
wais4 <- wais4 %>% dplyr::slice(5,1,6:7,2,9,8,10,3,12,11,13:15,4,21,20)
```

## Write out final csv

```{r write}
vroom::vroom_write(wais4, here::here(patient, "csv", "wais4.csv"), col_names = TRUE, na = "", delim = ", ")
```

## Cleanup

```{r cleanup}
rm(area, plucked_table, table1, table2, table3, table4, table5, table6, table7)
```

---
title: "Pluck Tables from CAARS"
params:
  patient: Biggie
  test:
    label: "CAARS"
    value: [caars_sr]
    input: select
    multiple: no
    choices:
      - caars_sr
      - caars_or
  test_name:
    label: "Test Name:"
    value: [CAARS Self-Report]
    input: select
    multiple: no
    choices:
      - CAARS Self-Report
      - CAARS Observer-Report
  file:
    label: "No file selected"
    value: file
    input: file
  pages: [3,3,3]
output:
  rmdformats::robobook:
    highlight: kate
---

# CAARS Long Version SR/OR

## Load libraries

```{r setup, include=FALSE}
Sys.setenv(JAVA_HOME = "/Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home")
options(java.parameters = "-Xmx16000m")
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = TRUE
)
library(bwu)
library(hablar)
library(here)
library(magrittr)
library(readr)
library(rJava)
library(rmarkdown)
library(rmdformats)
library(shiny)
library(tabulizer)
library(tabulizerjars)
library(tibble)
library(tidyr)
library(tidytable)
```

## Patient

```{r patient}
patient <- params$patient
```

## Test

```{r test}
test <- params$test
```

## Test Name

```{r testname}
test_name <- params$test_name
```

## Upload/attach PDF

```{r file}
# file <- file.choose()
file <- params$file
```

## Pages

```{r pages}
pages <- params$pages
```

```{r write-file}
writeLines(file, here::here(patient, "pre_csv", paste0(test, ".pdf")))
```

```{r read-file}
# test <- readLines(here::here(patient, "pre_csv", paste0(test, ".pdf")))
```

## Locate areas

```{r area-known}
if (params$test == "caars_sr") {
  area <- list(
    c(155, 73, 647, 208),
    c(155, 209, 647, 246),
    c(155, 247, 647, 283)
  )
}
if (params$test == "caars_or") {
  area <- list(
    c(155, 73, 650, 210),
    c(155, 209, 650, 246),
    c(155, 247, 650, 283)
  )
}
```

```{r area-unknown, eval=FALSE}
# area <- bwu::gpluck_locate_areas(
#   file = file,
#   pages = pages
# )
```

```{r save-area}
saveRDS(area, here::here(patient, "pre_csv", paste0(test, "_area.rds")))
```

```{r read-area}
# area <- readRDS(here::here(patient, "pre_csv", paste0(test, "_area.rds")))
```

## Extract table

```{r extract}
plucked_table <- bwu::gpluck_extract_table(
  file = file,
  pages = pages,
  area = area,
  guess = NULL,
  method = "stream",
  output = "matrix"
)
```

# Tidy Tables

## Column names per test/subtest/measure

```{r colnames}
colnames1 <- c("scale")
colnames2 <- c("raw_score")
colnames3 <- c("score")
```

## Pluck individual columns

```{r pluck1}
table1 <- tibble::as_tibble(plucked_table[[1]])
colnames(table1) <- colnames1
```

```{r tb1-rownames}
if (params$test == "caars_sr") {
  table1[1, 1] <- c("CAARS-SR Inattention/Memory Problems")
  table1[2, 1] <- c("CAARS-SR Hyperactivity/Restlessness")
  table1[3, 1] <- c("CAARS-SR Impulsivity/Emotional Lability")
  table1[4, 1] <- c("CAARS-SR Problems with Self-Concept")
  table1[5, 1] <- c("CAARS-SR DSM-5 Inattentive Symptoms")
  table1[6, 1] <- c("CAARS-SR DSM-5 Hyperactive-Impulsive Symptoms")
  table1[7, 1] <- c("CAARS-SR DSM-5 ADHD Symptoms Total")
  table1[8, 1] <- c("CAARS-SR ADHD Index")
  table1[9, 1] <- c("CAARS-SR Inconsistency Index")
  table1 <- table1[1:9, ]
} else {
  table1[1, 1] <- c("CAARS-OR Inattention/Memory Problems")
  table1[2, 1] <- c("CAARS-OR Hyperactivity/Restlessness")
  table1[3, 1] <- c("CAARS-OR Impulsivity/Emotional Lability")
  table1[4, 1] <- c("CAARS-OR Problems with Self-Concept")
  table1[5, 1] <- c("CAARS-OR DSM-5 Inattentive Symptoms")
  table1[6, 1] <- c("CAARS-OR DSM-5 Hyperactive-Impulsive Symptoms")
  table1[7, 1] <- c("CAARS-OR DSM-5 ADHD Symptoms Total")
  table1[8, 1] <- c("CAARS-OR ADHD Index")
  table1[9, 1] <- c("CAARS-OR Inconsistency Index")
  table1 <- table1[1:9, ]
}
```

```{r pluck2}
table2 <- tibble::as_tibble(plucked_table[[2]])
colnames(table2) <- colnames2
to_double <- c("raw_score")
table2 <- table2 |> hablar::convert(dbl(all_of(to_double)))
table2 <- table2[1:9, ]
```

```{r pluck3}
table3 <- tibble::as_tibble(plucked_table[[3]])
colnames(table3) <- colnames3
to_double <- c("score")
table3 <- table3 |> hablar::convert(dbl(all_of(to_double)))
table3 <- table3[1:9, ]
```

```{r bind}
table_merge <- tidytable::bind_cols(table1, table2, table3)
```

## Mutate columns

```{r mutate}
caars_clinical <- table_merge[1:8, ]
caars_clinical <- bwu::gpluck_make_columns(
  table = caars_clinical,
  scale = "",
  raw_score = "",
  score = "",
  percentile = "",
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "ADHD",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "",
  test_type = "rating_scale",
  score_type = "t_score",
  absort =
        paste0(
          tolower(test),
          "_", tolower(scale),
          "_", seq_len(nrow(table))
        ),
  description = "",
  result = ""
)

caars_validity <- table_merge[9, ]
caars_validity <- bwu::gpluck_make_columns(
  table = caars_validity,
  scale = "",
  raw_score = "",
  score = "",
  percentile = "",
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Symptom Validity",
  subdomain = "Response Inconsistency",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "",
  test_type = "validity_indicator",
  score_type = "raw_score",
      absort =
        paste0(
          tolower(test),
          "_", tolower(scale),
          "_", seq_len(nrow(table))
        ),
  description = "",
  result = ""
)
```

## Create percentile

```{r percentile}
caars_clinical <- caars_clinical %>%
  tidytable::mutate(z = (score - 50) / 10) %>%
  tidytable::mutate(percentile = trunc(pnorm(z) * 100)) %>%
  tidytable::select(-z)

if (caars_validity$raw_score >= 8) {
  caars_validity$percentile <- 84L
} else {
  caars_validity$percentile <- 50L
}
```

## Test score ranges

```{r ranges}
caars_clinical <- bwu::gpluck_make_score_ranges(
  table = caars_clinical,
  test_type = "npsych_test")
caars_validity <- bwu::gpluck_make_score_ranges(
  table = caars_validity,
  test_type = "validity_indicator")
```

## Subdomains

```{r subdomain}
caars_clinical[1, 10] <- c("Inattention/Memory Problems")
caars_clinical[2, 10] <- c("Hyperactivity/Restlessness")
caars_clinical[3, 10] <- c("Impulsivity/Emotional Lability")
caars_clinical[4, 10] <- c("Problems with Self-Concept")
caars_clinical[5, 10] <- c("DSM-5 Inattentive Symptoms")
caars_clinical[6, 10] <- c("DSM-5 Hyperactive-Impulsive Symptoms")
caars_clinical[7, 10] <- c("DSM-5 ADHD Symptoms Total")
caars_clinical[8, 10] <- c("ADHD Index")
```

## Narrow subdomains

```{r narrow}
if (params$test == "caars_sr") {
  caars_clinical <-
    caars_clinical |>
    tidytable::mutate(
      narrow = tidytable::case_when(
        scale ==
          "CAARS-SR Inattention/Memory Problems" ~ "CAARS-SR Inattention/Memory Problems",
        scale ==
          "CAARS-SR Hyperactivity/Restlessness" ~ "CAARS-SR Hyperactivity/Restlessness",
        scale ==
          "CAARS-SR Impulsivity/Emotional Lability" ~ "CAARS-SR Impulsivity/Emotional Lability",
        scale ==
          "CAARS-SR Problems with Self-Concept" ~ "CAARS-SR Problems with Self-Concept",
        scale ==
          "CAARS-SR DSM-5 Inattentive Symptoms" ~ "CAARS-SR DSM-5 Inattentive Symptoms",
        scale ==
          "CAARS-SR DSM-5 Hyperactive-Impulsive Symptoms" ~ "CAARS-SR DSM-5 Hyperactive-Impulsive Symptoms",
        scale ==
          "CAARS-SR DSM-5 ADHD Symptoms Total" ~ "CAARS-SR DSM-5 ADHD Symptoms Total",
        scale ==
          "CAARS-SR ADHD Index" ~ "CAARS-SR ADHD Index",
        TRUE ~ as.character(narrow)
      )
    )
} else {
  caars_clinical <-
    caars_clinical |>
    tidytable::mutate(
      narrow = tidytable::case_when(
        scale ==
          "CAARS-OR Inattention/Memory Problems" ~ "CAARS-OR Inattention/Memory Problems",
        scale ==
          "CAARS-OR Hyperactivity/Restlessness" ~ "CAARS-OR Hyperactivity/Restlessness",
        scale ==
          "CAARS-OR Impulsivity/Emotional Lability" ~ "CAARS-OR Impulsivity/Emotional Lability",
        scale ==
          "CAARS-OR Problems with Self-Concept" ~ "CAARS-OR Problems with Self-Concept",
        scale ==
          "CAARS-OR DSM-5 Inattentive Symptoms" ~ "CAARS-OR DSM-5 Inattentive Symptoms",
        scale ==
          "CAARS-OR DSM-5 Hyperactive-Impulsive Symptoms" ~ "CAARS-OR DSM-5 Hyperactive-Impulsive Symptoms",
        scale ==
          "CAARS-OR DSM-5 ADHD Symptoms Total" ~ "CAARS-OR DSM-5 ADHD Symptoms Total",
        scale ==
          "CAARS-OR ADHD Index" ~ "CAARS-OR ADHD Index",
        TRUE ~ as.character(narrow)
      )
    )
}

if (params$test == "caars_sr") {
  caars_validity <-
    caars_validity |>
    tidytable::mutate(
      narrow = tidytable::case_when(
        scale ==
          "CAARS-SR Inconsistency Index" ~ "CAARS-SR Inconsistency Index",
        TRUE ~ as.character(narrow)
      )
    )
} else {
  caars_validity <-
    caars_validity |>
    tidytable::mutate(
      narrow = tidytable::case_when(
        scale ==
          "CAARS-OR Inconsistency Index" ~ "CAARS-OR Inconsistency Index",
        TRUE ~ as.character(narrow)
      )
    )
}
```

## Scale descriptions

```{r description}
if (params$test == "caars_sr") {
  caars_clinical <-
    caars_clinical |>
    tidytable::mutate(
      description = tidytable::case_when(
        scale == "CAARS-SR ADHD Index" ~ "composite indicator for identifying individuals 'at-risk' for ADHD",
        scale == "CAARS-SR Inattention/Memory Problems" ~ "i.e., trouble concentrating, difficulty planning or completing tasks, forgetfulness, absent-mindedness, being disorganized",
        scale == "CAARS-SR Hyperactivity/Restlessness" ~ "i.e., problems with working at the same task for long periods of time, feeling more restless than others seem to be, fidgeting",
        scale == "CAARS-SR Impulsivity/Emotional Lability" ~ "i.e., engaging in more impulsive acts than others do, low frustration tolerance, quick and frequent mood changes, feeling easily angered and irritated by people",
        scale == "CAARS-SR Problems with Self-Concept" ~ "i.e., poor social relationships, low self-esteem and self confidence",
        scale == "CAARS-SR DSM-5 Inattentive Symptoms" ~ "i.e., behave in a manner consistent with the DSM-5 Inattentive Presentation of ADHD",
        scale == "CAARS-SR DSM-5 Hyperactive-Impulsive Symptoms" ~ "i.e., behave in a manner consistent with the DSM-5 Hyperactive-Impulsive Presentation of ADHD",
        scale == "CAARS-SR DSM-5 ADHD Symptoms Total" ~ "i.e., behave in a manner consistent with the DSM-5 diagnostic criteria for Combined Presentation of ADHD",
        TRUE ~ as.character(description)
      )
    )
} else if (params$test == "caars_or") {
  caars_clinical <-
    caars_clinical |>
    tidytable::mutate(
      description = tidytable::case_when(
        scale == "CAARS-OR ADHD Index" ~ "composite indicator for identifying individuals 'at-risk' for ADHD",
        scale == "CAARS-OR Inattention/Memory Problems" ~ "i.e., trouble concentrating, difficulty planning or completing tasks, forgetfulness, absent-mindedness, being disorganized",
        scale == "CAARS-OR Hyperactivity/Restlessness" ~ "i.e., problems with working at the same task for long periods of time, feeling more restless than others seem to be, fidgeting",
        scale == "CAARS-OR Impulsivity/Emotional Lability" ~ "i.e., engaging in more impulsive acts than others do, low frustration tolerance, quick and frequent mood changes, feeling easily angered and irritated by people",
        scale == "CAARS-OR Problems with Self-Concept" ~ "i.e., poor social relationships, low self-esteem and self confidence",
        scale == "CAARS-OR DSM-5 Inattentive Symptoms" ~ "i.e., behave in a manner consistent with the DSM-5 Inattentive Presentation of ADHD",
        scale == "CAARS-OR DSM-5 Hyperactive-Impulsive Symptoms" ~ "i.e., behave in a manner consistent with the DSM-5 Hyperactive-Impulsive Presentation of ADHD",
        scale == "CAARS-OR DSM-5 ADHD Symptoms Total" ~ "i.e., behave in a manner consistent with the DSM-5 diagnostic criteria for Combined Presentation of ADHD",
        TRUE ~ as.character(description)
      )
    )
}

if (params$test == "caars_sr" & caars_validity$raw_score >= 8) {
  caars_validity <-
    caars_validity |>
    tidytable::mutate(
      description = tidytable::case_when(
        scale == "CAARS-SR Inconsistency Index" ~ "probably invalid, as there may be some inconsistency in the responses",
        TRUE ~ as.character(description)
      )
    )
} else if (params$test == "caars_sr" & caars_validity$raw_score <= 7) {
  caars_validity <-
    caars_validity |>
    tidytable::mutate(
      description = tidytable::case_when(
        scale == "CAARS-SR Inconsistency Index" ~ "probably valid",
        TRUE ~ as.character(description)
      )
    )
} else if (params$test == "caars_or" & caars_validity$raw_score >= 8) {
  caars_validity <-
    caars_validity |>
    tidytable::mutate(
      description = tidytable::case_when(
        scale == "CAARS-OR Inconsistency Index" ~ "probably invalid, as there may be some inconsistency in the responses",
        TRUE ~ as.character(description)
      )
    )
} else if (params$test == "caars_or" & caars_validity$raw_score <= 7) {
  caars_validity <-
    caars_validity |>
    tidytable::mutate(
      description = tidytable::case_when(
        scale == "CAARS-OR Inconsistency Index" ~ "probably valid",
        TRUE ~ as.character(description)
      )
    )
}
```

## Glue results

```{r result}
if (params$test == "caars_sr") {
  caars_clinical <-
    caars_clinical |>
    tidytable::mutate(
      result = tidytable::case_when(
        scale == "CAARS-SR ADHD Index" ~ glue::glue("- {patient}'s {description} was {range}\n"
        ),
        scale == "CAARS-SR Inattention/Memory Problems" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-SR Hyperactivity/Restlessness" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-SR Impulsivity/Emotional Lability" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-SR Problems with Self-Concept" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-SR DSM-5 Inattentive Symptoms" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-SR DSM-5 Hyperactive-Impulsive Symptoms" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-SR DSM-5 ADHD Symptoms Total" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        TRUE ~ as.character(result)
      )
    )
} else if (params$test == "caars_or") {
  caars_clinical <-
    caars_clinical |>
    tidytable::mutate(
      result = tidytable::case_when(
        scale == "CAARS-OR ADHD Index" ~ glue::glue("- {patient}'s {description} was {range}\n"
        ),
        scale == "CAARS-OR Inattention/Memory Problems" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-OR Hyperactivity/Restlessness" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-OR Impulsivity/Emotional Lability" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-OR Problems with Self-Concept" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-OR DSM-5 Inattentive Symptoms" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-OR DSM-5 Hyperactive-Impulsive Symptoms" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        scale == "CAARS-OR DSM-5 ADHD Symptoms Total" ~ glue::glue("- {scale} ({description}) was {range}\n"
        ),
        TRUE ~ as.character(result)
      )
    )
}

if (params$test == "caars_sr") {
  caars_validity <-
    caars_validity |>
    tidytable::mutate(
      result = tidytable::case_when(
        scale == "CAARS-SR Inconsistency Index" ~ glue::glue("- The {scale} was {description}\n"
        ),
        TRUE ~ as.character(result)
      )
    )
} else if (params$test == "caars_or") {
  caars_validity <-
    caars_validity |>
    tidytable::mutate(
      result = tidytable::case_when(
        scale == "CAARS-OR Inconsistency Index" ~ glue::glue("- The {scale} was {description}\n"
        ),
        TRUE ~ as.character(result)
      )
    )
}
```

# Finalize and save

## Relocate variables

```{r relocate}
caars_clinical <-
  caars_clinical |>
  tidytable::relocate(
    c(raw_score, score, percentile, range, ci_95), .before = test
  )
caars_validity <-
  caars_validity |>
  tidytable::relocate(
    c(raw_score, score, percentile, range, ci_95), .before = test
  )

if (params$test == "caars_sr") {
  caars_sr <- rbind(caars_clinical, caars_validity)
} else {
  caars_or <- rbind(caars_clinical, caars_validity)
}
```

## Write out csv

```{r writeout}
if (params$test == "caars_sr") {
  readr::write_csv(caars_sr, here::here(patient, "csv", paste0(test, ".csv")),
    col_names = TRUE, na = "")
} else {
  readr::write_csv(caars_or, here::here(patient, "csv", paste0(test, ".csv")),
    col_names = TRUE, na = "")
}
```
